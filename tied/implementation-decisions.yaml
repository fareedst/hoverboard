IMPL-TIED_FILES:
  name: TIED File Creation
  status: Active
  cross_references:
    - ARCH-TIED_STRUCTURE
    - REQ-TIED_SETUP
  rationale:
    why: Implements ARCH-TIED_STRUCTURE and realizes REQ-TIED_SETUP by creating the foundational TIED directory structure and files
    problems_solved:
      - Manual setup of TIED structure is error-prone
      - Inconsistent project structure across implementations
      - Missing required TIED files and directories
    benefits:
      - Automated, consistent TIED setup
      - All required files and directories created correctly
      - Easy project bootstrapping with single command
  implementation_approach:
    summary: Bootstrap script that creates tied/ directory, copies template files, and sets up base files
    details:
      - Create tied/ directory at project root
      - Copy YAML index files from templates (requirements.yaml, architecture-decisions.yaml, implementation-decisions.yaml, semantic-tokens.yaml)
      - Copy guide files from templates (semantic-tokens.md, processes.md)
      - Create detail subdirectories (requirements/, architecture-decisions/, implementation-decisions/)
      - Copy base files to project root (.cursorrules, AGENTS.md, ai-principles.md)
  code_locations:
    files:
      - path: copy_files.sh
        description: Bootstrap script that sets up TIED structure
        lines:
          - 1
          - 163
    functions:
      - name: setup_tied_structure
        file: copy_files.sh
        description: Creates directories and copies template files (if implemented as function)
  traceability:
    architecture:
      - ARCH-TIED_STRUCTURE
    requirements:
      - REQ-TIED_SETUP
    tests:
      - Manual verification checklists
    code_annotations:
      - IMPL-TIED_FILES
      - ARCH-TIED_STRUCTURE
      - REQ-TIED_SETUP
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - ARCH-TIED_STRUCTURE
      - REQ-TIED_SETUP
  detail_file: implementation-decisions/IMPL-TIED_FILES.yaml
  metadata:
    created:
      date: 2025-12-18T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-06T00:00:00.000Z
      author: AI Agent
      reason: Restructured to v1.5.0 schema with machine-parseable fields
    last_validated:
      date: 2026-02-06T00:00:00.000Z
      validator: AI Agent
      result: pass
IMPL-MODULE_VALIDATION:
  name: Module Validation Implementation
  status: Active
  cross_references:
    - ARCH-MODULE_VALIDATION
    - REQ-MODULE_VALIDATION
  rationale:
    why: Implements REQ-MODULE_VALIDATION requirement and ARCH-MODULE_VALIDATION strategy to ensure modules are validated independently before integration
    problems_solved:
      - Complexity-related bugs discovered too late
      - Difficult to debug integration issues
      - Module contracts not validated before integration
    benefits:
      - Bugs caught early in development cycle
      - Easier debugging by isolating issues to specific modules
      - Clear validation criteria for each module
      - Reduced integration complexity
  implementation_approach:
    summary: 'Five-phase approach: module identification, independent development, independent validation, documentation, and integration'
    details:
      - 'Phase 1: Identify modules and document boundaries, interfaces, contracts, dependencies, validation criteria'
      - 'Phase 2: Develop module independently with dependency injection'
      - 'Phase 3: Validate independently with unit tests (mocked dependencies), contract validation, edge cases, error handling, integration tests with test doubles'
      - 'Phase 4: Document validation results including passed tests, limitations, assumptions'
      - 'Phase 5: Integrate only after validation passes, with integration tests validating combined behavior'
  code_locations:
    files:
      - path: '*_module_test.[ext]'
        description: Module validation test files
      - path: '*_validation_test.[ext]'
        description: Module validation test files (alternate pattern)
      - path: '*_integration_test.[ext]'
        description: Integration test files
    functions:
      - name: testModuleName_IndependentValidation_REQ_MODULE_VALIDATION
        file: various test files
        description: Module validation test function pattern
  traceability:
    architecture:
      - ARCH-MODULE_VALIDATION
    requirements:
      - REQ-MODULE_VALIDATION
    tests:
      - testModuleName_IndependentValidation_REQ_MODULE_VALIDATION
    code_annotations:
      - IMPL-MODULE_VALIDATION
      - REQ-MODULE_VALIDATION
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - ARCH-MODULE_VALIDATION
      - REQ-MODULE_VALIDATION
  detail_file: implementation-decisions/IMPL-MODULE_VALIDATION.yaml
  metadata:
    created:
      date: 2025-12-18T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-06T00:00:00.000Z
      author: AI Agent
      reason: Restructured to v1.5.0 schema with machine-parseable fields
    last_validated:
      date: 2026-02-06T00:00:00.000Z
      validator: AI Agent
      result: pass
IMPL-PINBOARD_API:
  name: Pinboard API Service Implementation
  status: Active
  cross_references:
    - ARCH-PINBOARD_API
    - REQ-PINBOARD_COMPATIBILITY
  rationale:
    why: Concrete API integration with error handling
    problems_solved:
      - API communication complexity
      - Rate limiting issues
    benefits:
      - Reliable API access
      - Proper error handling
  implementation_approach:
    summary: Token-based auth with endpoint wrappers, rate limiting, retry logic
    details:
      - 'API endpoints: /posts/get, /posts/recent, /posts/add, /posts/delete'
      - Token authentication
      - 429 retry logic
      - 401 error handling
  code_locations:
    files:
      - path: src/features/pinboard/pinboard-service.js
        description: Pinboard API service
      - path: src/features/pinboard/pinboard-service-browser.js
        description: Browser-specific Pinboard API usage
    functions: []
  traceability:
    architecture:
      - ARCH-PINBOARD_API
    requirements:
      - REQ-PINBOARD_COMPATIBILITY
    tests: []
    code_annotations:
      - IMPL-PINBOARD_API
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
  detail_file: implementation-decisions/IMPL-PINBOARD_API.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-MESSAGE_HANDLING:
  name: Message Handling System Implementation
  status: Active
  cross_references:
    - ARCH-MESSAGE_HANDLING
    - REQ-SMART_BOOKMARKING
  rationale:
    why: Concrete message routing and handling
    problems_solved:
      - Complex routing logic
      - Message validation
    benefits:
      - Centralized communication
      - Type-safe messages
  implementation_approach:
    summary: Message service with type validation, routing, error handling
    details:
      - Standardized message types
      - Async request/response
      - Error handling
      - Input validation
  code_locations:
    files:
      - path: src/core/message-service.js
        description: Message service
      - path: src/core/message-handler.js
        description: Message handler
    functions: []
  traceability:
    architecture:
      - ARCH-MESSAGE_HANDLING
    requirements:
      - REQ-SMART_BOOKMARKING
      - REQ-BOOKMARK_STATE_SYNCHRONIZATION
    tests: []
    code_annotations:
      - IMPL-MESSAGE_HANDLING
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
  detail_file: implementation-decisions/IMPL-MESSAGE_HANDLING.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-RUNTIME_VALIDATION:
  name: Runtime validation with Zod for messages and config
  status: Active
  cross_references:
    - IMPL-MESSAGE_HANDLING
    - ARCH-MESSAGE_HANDLING
    - ARCH-CONFIG_STRUCTURE
  rationale:
    why: Validate message payloads and merged config at boundaries to prevent invalid data from breaking the extension
    problems_solved:
      - Invalid or malicious message payloads reaching handlers
      - Corrupted or wrongly-typed stored config breaking getConfig()
    benefits:
      - Structured error responses for invalid messages
      - Safe fallback to defaults when stored config fails validation
      - Incremental coverage (only critical message types and config)
  implementation_approach:
    summary: Zod schemas in shared/message-schemas.js and config-manager.js; validate at processMessage entry and in getConfig() after merge
    details:
      - Message envelope (type + optional data) validated for all messages in message-handler processMessage
      - Data schemas for critical types: getCurrentBookmark, getTagsForUrl, saveBookmark, deleteBookmark, saveTag, deleteTag
      - getCurrentBookmark schema uses .passthrough() so senders (e.g. overlay-manager) may include url, title, tabId
      - Config schema validates merged (defaults + stored) config in ConfigManager.getConfig(); on failure use defaults
      - Validation is incremental: message types without a schema pass through; config schema uses passthrough for future keys
  code_locations:
    files:
      - path: src/shared/message-schemas.js
        description: Zod message envelope and data schemas; validateMessageEnvelope, validateMessageData
      - path: src/core/message-handler.js
        description: processMessage calls validateMessageEnvelope and validateMessageData before dispatch
      - path: src/config/config-manager.js
        description: mergedConfigSchema and getConfig() safeParse with fallback to defaults
      - path: src/features/content/overlay-manager.js
        description: Sends getCurrentBookmark with url, title, tabId (IMPL-RUNTIME_VALIDATION passthrough)
    functions: []
  traceability:
    architecture:
      - ARCH-MESSAGE_HANDLING
      - ARCH-CONFIG_STRUCTURE
    requirements: []
    tests:
      - tests/unit/message-schemas.test.js
      - tests/unit/config-manager.test.js
    code_annotations:
      - IMPL-RUNTIME_VALIDATION
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-MESSAGE_HANDLING
      - IMPL-CONFIG_STRUCT
  detail_file: implementation-decisions/IMPL-RUNTIME_VALIDATION.yaml
  metadata:
    created:
      date: "2026-02-22"
      author: AI Agent
    last_updated:
      date: "2026-02-22"
      author: AI Agent
      reason: Initial creation for Zod message and config validation
IMPL-TYPESCRIPT_MIGRATION:
  name: Incremental TypeScript and JSDoc typing
  status: Active
  cross_references:
    - ARCH-LANGUAGE_SELECTION
    - IMPL-MESSAGE_HANDLING
    - IMPL-RUNTIME_VALIDATION
  rationale:
    why: Implements ARCH-LANGUAGE_SELECTION; add static typing without big-bang rewrite
    benefits:
      - typecheck script in CI and validate; JSDoc documents public APIs
  implementation_approach:
    summary: tsconfig noEmit, typecheck script, .d.ts for message and config; JSDoc on core and popup sendMessage
  code_locations:
    files:
      - path: tsconfig.json
      - path: src/shared/message-types.d.ts
      - path: src/shared/config-types.d.ts
  traceability:
    architecture:
      - ARCH-LANGUAGE_SELECTION
    code_annotations:
      - IMPL-TYPESCRIPT_MIGRATION
  detail_file: implementation-decisions/IMPL-TYPESCRIPT_MIGRATION.yaml
  metadata:
    created:
      date: "2026-02-22"
      author: AI Agent
    last_updated:
      date: "2026-02-22"
      author: AI Agent
      reason: Initial creation for incremental TypeScript/JSDoc
IMPL-PLAYWRIGHT_E2E_EXTENSION:
  name: Playwright E2E for extension (load unpacked, popup flow)
  status: Active
  cross_references:
    - REQ-UI_INSPECTION
    - ARCH-UI_TESTABILITY
  rationale:
    why: One reliable E2E flow that loads the built extension and asserts popup so refactors are guarded
  implementation_approach:
    summary: playwright.extension.config.js; global-setup builds extension; extension-popup.spec.js uses launchPersistentContext, discovers ID, opens popup, asserts structure
  code_locations:
    files:
      - path: playwright.extension.config.js
      - path: tests/playwright/extension-popup.spec.js
  traceability:
    architecture:
      - ARCH-UI_TESTABILITY
    requirements:
      - REQ-UI_INSPECTION
    code_annotations:
      - IMPL-PLAYWRIGHT_E2E_EXTENSION
  detail_file: implementation-decisions/IMPL-PLAYWRIGHT_E2E_EXTENSION.yaml
  metadata:
    created:
      date: "2026-02-22"
      author: AI Agent
    last_updated:
      date: "2026-02-22"
      author: AI Agent
      reason: Initial creation for extension E2E flow
IMPL-OVERLAY:
  name: Overlay Implementation
  status: Active
  cross_references:
    - ARCH-OVERLAY
    - REQ-OVERLAY_SYSTEM
  rationale:
    why: Concrete overlay rendering and interaction
    problems_solved:
      - Overlay display complexity
      - Interaction handling
    benefits:
      - Working overlay
      - Proper lifecycle
  implementation_approach:
    summary: Overlay manager with show/hide, content rendering, control creation
    details:
      - Overlay DOM injection
      - Transparency controls
      - Auto-show logic
      - Refresh control
      - Theme integration
  code_locations:
    files:
      - path: src/features/content/overlay-manager.js
        description: Overlay manager
    functions:
      - name: show
        description: Display overlay
        file: src/features/content/overlay-manager.js
      - name: hide
        description: Hide overlay
        file: src/features/content/overlay-manager.js
      - name: createCloseButton
        description: Create close control
        file: src/features/content/overlay-manager.js
      - name: createRefreshButton
        description: Create refresh control
        file: src/features/content/overlay-manager.js
  traceability:
    architecture:
      - ARCH-OVERLAY
    requirements:
      - REQ-OVERLAY_SYSTEM
      - REQ-OVERLAY_AUTO_SHOW_CONTROL
      - REQ-OVERLAY_REFRESH_ACTION
    tests: []
    code_annotations:
      - IMPL-OVERLAY
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-OVERLAY_CONTROLS
  detail_file: implementation-decisions/IMPL-OVERLAY.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-TAG_SYSTEM:
  name: Tag Service Implementation
  status: Active
  cross_references:
    - ARCH-TAG_SYSTEM
    - REQ-RECENT_TAGS_SYSTEM
    - REQ-TAG_INPUT_SANITIZATION
  rationale:
    why: Concrete tag management logic
    problems_solved:
      - Tag sanitization
      - Recent tags tracking
    benefits:
      - Secure tag handling
      - Fast tag reuse
  implementation_approach:
    summary: TagService with sanitization, recent tags caching, suggestions
    details:
      - sanitizeTag function
      - Recent tags TTL caching
      - Tag history persistence
      - Suggestion algorithm
  code_locations:
    files:
      - path: src/features/tagging/tag-service.js
        description: Tag service
    functions:
      - name: sanitizeTag
        description: Tag sanitization
        file: src/features/tagging/tag-service.js
      - name: getRecentTags
        description: Recent tags retrieval
        file: src/features/tagging/tag-service.js
  traceability:
    architecture:
      - ARCH-TAG_SYSTEM
    requirements:
      - REQ-RECENT_TAGS_SYSTEM
      - REQ-TAG_MANAGEMENT
      - REQ-TAG_INPUT_SANITIZATION
    tests: []
    code_annotations:
      - IMPL-TAG_SYSTEM
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-SUGGESTED_TAGS
  detail_file: implementation-decisions/IMPL-TAG_SYSTEM.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-POPUP_SESSION:
  name: Popup Session Persistence Implementation
  status: Active
  cross_references:
    - ARCH-POPUP_SESSION
    - REQ-POPUP_PERSISTENT_SESSION
  rationale:
    why: Multi-action workflows without reopening
    problems_solved:
      - Popup closing interrupts work
      - State management complexity
    benefits:
      - Continuous workflows
      - Better UX
  implementation_approach:
    summary: PopupController routing with StateManager, UIManager, no window.close
    details:
      - PopupController handlers await async work
      - StateManager mutations
      - UIManager updates
      - GET_OVERLAY_STATE fallback
      - Inline notifications
  code_locations:
    files:
      - path: src/ui/popup/PopupController.js
        description: Popup controller
      - path: src/ui/popup/UIManager.js
        description: UI manager
    functions:
      - name: handleShowHoverboard
        description: Overlay toggle handler
        file: src/ui/popup/PopupController.js
      - name: handleTogglePrivate
        description: Privacy toggle
        file: src/ui/popup/PopupController.js
      - name: updateShowHoverButtonState
        description: Button state updater
        file: src/ui/popup/UIManager.js
  traceability:
    architecture:
      - ARCH-POPUP_SESSION
    requirements:
      - REQ-POPUP_PERSISTENT_SESSION
    tests: []
    code_annotations:
      - IMPL-POPUP_SESSION
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-MESSAGE_HANDLING
  detail_file: implementation-decisions/IMPL-POPUP_SESSION.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-BOOKMARK_STATE_SYNC:
  name: Bookmark State Synchronization Implementation
  status: Active
  cross_references:
    - ARCH-BOOKMARK_STATE_SYNC
    - REQ-BOOKMARK_STATE_SYNCHRONIZATION
  rationale:
    why: Consistent state across surfaces
    problems_solved:
      - State divergence
      - Race conditions
    benefits:
      - Reliable sync
      - Observable contract
  implementation_approach:
    summary: BOOKMARK_UPDATED broadcast with overlay persist, popup refresh, badge update
    details:
      - Overlay toggle handlers persist via saveBookmark
      - BOOKMARK_UPDATED broadcast
      - PopupController listener refreshes data
      - Badge compares states
  code_locations:
    files:
      - path: src/features/content/overlay-manager.js
        description: Overlay manager
      - path: src/ui/popup/PopupController.js
        description: Popup controller
      - path: src/core/badge-manager.js
        description: Badge manager
    functions: []
  traceability:
    architecture:
      - ARCH-BOOKMARK_STATE_SYNC
    requirements:
      - REQ-BOOKMARK_STATE_SYNCHRONIZATION
    tests: []
    code_annotations:
      - IMPL-BOOKMARK_STATE_SYNC
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-MESSAGE_HANDLING
  detail_file: implementation-decisions/IMPL-BOOKMARK_STATE_SYNC.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-OVERLAY_CONTROLS:
  name: Overlay Control Layout Implementation
  status: Active
  cross_references:
    - ARCH-OVERLAY_CONTROLS
    - REQ-OVERLAY_CONTROL_LAYOUT
  rationale:
    why: Deterministic control placement
    problems_solved:
      - Positioning inconsistency
      - Accessibility gaps
    benefits:
      - Predictable layout
      - Full accessibility
  implementation_approach:
    summary: Helper functions with inline styles, theme variables, ARIA metadata
    details:
      - Fixed absolute positioning
      - 24px min touch targets
      - Theme CSS variables
      - ARIA metadata
      - Keyboard handlers
  code_locations:
    files:
      - path: src/features/content/overlay-manager.js
        description: Overlay manager
    functions:
      - name: createCloseButton
        description: Close control creator
        file: src/features/content/overlay-manager.js
      - name: createRefreshButton
        description: Refresh control creator
        file: src/features/content/overlay-manager.js
  traceability:
    architecture:
      - ARCH-OVERLAY_CONTROLS
    requirements:
      - REQ-OVERLAY_CONTROL_LAYOUT
    tests: []
    code_annotations:
      - IMPL-OVERLAY_CONTROLS
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-OVERLAY
  detail_file: implementation-decisions/IMPL-OVERLAY_CONTROLS.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-SAFARI_ADAPTATION:
  name: Safari Adaptive Implementation
  status: Active
  cross_references:
    - ARCH-SAFARI_ADAPTATION
    - REQ-SAFARI_ADAPTATION
  rationale:
    why: Safari stability and performance
    problems_solved:
      - Safari memory issues
      - Messaging failures
    benefits:
      - Stable Safari support
      - Bounded recovery
  implementation_approach:
    summary: Safari shim, content optimizations, error handler with degraded mode
    details:
      - Platform detection
      - Safari config (timeouts, retries)
      - Animation/memory optimizations
      - Error handler with recovery
      - Degraded mode
  code_locations:
    files:
      - path: src/shared/safari-shim.js
        description: Safari shim
      - path: safari/src/shared/ErrorHandler.js
        description: Safari error handler
    functions:
      - name: getSafariConfig
        description: Safari config
        file: src/shared/safari-shim.js
      - name: optimizeSafariAnimations
        description: Animation optimization
        file: src/shared/safari-shim.js
  traceability:
    architecture:
      - ARCH-SAFARI_ADAPTATION
    requirements:
      - REQ-SAFARI_ADAPTATION
    tests: []
    code_annotations:
      - IMPL-SAFARI_ADAPTATION
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-CROSS_BROWSER
  detail_file: implementation-decisions/IMPL-SAFARI_ADAPTATION.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-SUGGESTED_TAGS:
  name: Suggested Tags Implementation
  status: Active
  cross_references:
    - ARCH-SUGGESTED_TAGS
    - REQ-SUGGESTED_TAGS_FROM_CONTENT
    - REQ-SUGGESTED_TAGS_DEDUPLICATION
    - REQ-SUGGESTED_TAGS_CASE_PRESERVATION
  rationale:
    why: Multi-source extraction with intelligent filtering
    problems_solved:
      - Manual tag entry
      - No context awareness
    benefits:
      - Smart suggestions
      - Faster tagging
  implementation_approach:
    summary: Extract from title/URL/meta/headings/emphasis/structured content/nav/breadcrumbs/images/links, frequency sort, case preserve
    details:
      - Multi-source extraction including meta tags, emphasis elements (strong/em/mark/dfn/cite/kbd/code), definition terms, and table headers
      - Title attribute priority
      - Noise filtering
      - Frequency counting and sorting
      - Case preservation (both versions)
      - Case-insensitive deduplication
  code_locations:
    files:
      - path: src/features/tagging/tag-service.js
        description: Tag service with core extraction algorithm
      - path: src/features/content/overlay-manager.js
        description: Overlay display with suggested section
      - path: src/ui/popup/PopupController.js
        description: Popup extraction with inlined script
      - path: src/ui/popup/UIManager.js
        description: Popup display of suggested tags
    functions:
      - name: extractSuggestedTagsFromContent
        description: Core extraction algorithm (overlay path)
        file: src/features/tagging/tag-service.js
      - name: loadSuggestedTags
        description: Popup extraction via script injection
        file: src/ui/popup/PopupController.js
      - name: Inlined extraction function
        description: Duplicated extraction logic in executeScript
        file: src/ui/popup/PopupController.js
      - name: updateSuggestedTags
        description: Render suggested tags in popup UI
        file: src/ui/popup/UIManager.js
  traceability:
    architecture:
      - ARCH-SUGGESTED_TAGS
    requirements:
      - REQ-SUGGESTED_TAGS_FROM_CONTENT
      - REQ-SUGGESTED_TAGS_DEDUPLICATION
      - REQ-SUGGESTED_TAGS_CASE_PRESERVATION
    tests: []
    code_annotations:
      - IMPL-SUGGESTED_TAGS
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-TAG_SYSTEM
  detail_file: implementation-decisions/IMPL-SUGGESTED_TAGS.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Enhanced with meta tags, emphasis elements, and structured content extraction
IMPL-OVERLAY_TEST_HARNESS:
  name: Overlay Test Harness Implementation
  status: Active
  cross_references:
    - ARCH-OVERLAY_TESTABILITY
    - REQ-OVERLAY_SYSTEM
  rationale:
    why: Mock DOM for deterministic overlay testing
    problems_solved:
      - Stale test registries
      - Heavy DOM emulation
    benefits:
      - Lightweight tests
      - Auto-registration
  implementation_approach:
    summary: Mock DOM with className/id auto-registration, classList/attribute hooks
    details:
      - Auto-register on property assignments
      - classList operations tracking
      - Lightweight verification
  code_locations:
    files:
      - path: tests/utils/mock-dom.js
        description: Mock DOM utilities
    functions: []
  traceability:
    architecture:
      - ARCH-OVERLAY_TESTABILITY
    requirements:
      - REQ-OVERLAY_SYSTEM
      - REQ-OVERLAY_CONTROL_LAYOUT
    tests: []
    code_annotations:
      - IMPL-OVERLAY_TEST_HARNESS
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-OVERLAY
  detail_file: implementation-decisions/IMPL-OVERLAY_TEST_HARNESS.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-POPUP_MESSAGE_TIMEOUT:
  name: Popup Message Timeout Implementation
  status: Active
  cross_references: []
  rationale:
    why: Predictable refresh behavior in tests and runtime
    problems_solved:
      - Hanging messages
      - Test timeouts
    benefits:
      - Reliable messaging
      - Testable timeouts
  implementation_approach:
    summary: Promise-based message sending with timeout handling
    details:
      - Timeout logic
      - Error handling
      - Test mock support
  code_locations:
    files:
      - path: src/ui/popup/PopupController.js
        description: Popup controller
    functions: []
  traceability:
    architecture: []
    requirements: []
    tests: []
    code_annotations:
      - IMPL-POPUP_MESSAGE_TIMEOUT
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-MESSAGE_HANDLING
  detail_file: implementation-decisions/IMPL-POPUP_MESSAGE_TIMEOUT.yaml
  metadata:
    created:
      date: 2025-07-14T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
      reason: Migrated from STDD to TIED format
IMPL-UI_ACTION_CONTRACT:
  name: UI Action Contract
  status: Active
  cross_references:
    - ARCH-UI_TESTABILITY
    - REQ-UI_INSPECTION
  rationale:
    why: Single source of truth for message types and popup/overlay action IDs for tests and inspector
    problems_solved:
      - Scattered message type and action definitions
    benefits:
      - Tests and E2E use same contract
  implementation_approach:
    summary: src/shared/ui-action-contract.js re-exports MESSAGE_TYPES; exports POPUP_ACTION_IDS, POPUP_ACTION_TO_MESSAGE, CONTENT_MESSAGE_TYPES, OVERLAY_ACTION_IDS
  code_locations:
    files:
      - path: src/shared/ui-action-contract.js
  traceability:
    architecture:
      - ARCH-UI_TESTABILITY
    requirements:
      - REQ-UI_INSPECTION
    code_annotations:
      - IMPL-UI_ACTION_CONTRACT
  detail_file: implementation-decisions/IMPL-UI_ACTION_CONTRACT.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Extracted from index to detail file
IMPL-UI_INSPECTOR:
  name: UI Inspector
  status: Active
  cross_references:
    - ARCH-UI_TESTABILITY
    - REQ-UI_INSPECTION
  rationale:
    why: Optional action and message log for testing and debugging when enabled
    problems_solved:
      - Cannot inspect message flow and UI actions in tests or manually
    benefits:
      - recordMessage/recordAction ring buffers; getLastMessages/getLastActions; gated by DEBUG_HOVERBOARD_UI or setEnabled
  implementation_approach:
    summary: src/shared/ui-inspector.js; wired in service-worker (recordMessage), PopupController (recordAction), content-main (recordAction)
  code_locations:
    files:
      - path: src/shared/ui-inspector.js
      - path: src/core/service-worker.js
      - path: src/ui/popup/PopupController.js
      - path: src/features/content/content-main.js
  traceability:
    architecture:
      - ARCH-UI_TESTABILITY
    requirements:
      - REQ-UI_INSPECTION
    code_annotations:
      - IMPL-UI_INSPECTOR
  detail_file: implementation-decisions/IMPL-UI_INSPECTOR.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Extracted from index to detail file
IMPL-UI_TESTABILITY_HOOKS:
  name: UI Testability Hooks
  status: Active
  cross_references:
    - ARCH-UI_TESTABILITY
    - REQ-UI_INSPECTION
    - REQ-MODULE_VALIDATION
  rationale:
    why: Optional callbacks so unit/integration tests can assert on message handling and UI state without DOM
    problems_solved:
      - Tests cannot observe message flow or popup/overlay state without DOM
    benefits:
      - MessageHandler.setOnMessageProcessed(fn); PopupController.setOnAction(fn), setOnStateChange(fn); OverlayManager.setOnStateChange(fn)
  implementation_approach:
    summary: Optional _onMessageProcessed in MessageHandler (called after processMessage); _onAction/_onStateChange in PopupController; _onStateChange in OverlayManager (visible, contentSnapshot)
  code_locations:
    files:
      - path: src/core/message-handler.js
      - path: src/ui/popup/PopupController.js
      - path: src/features/content/overlay-manager.js
  traceability:
    architecture:
      - ARCH-UI_TESTABILITY
    requirements:
      - REQ-UI_INSPECTION
      - REQ-MODULE_VALIDATION
  detail_file: implementation-decisions/IMPL-UI_TESTABILITY_HOOKS.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Extracted from index to detail file
IMPL-DEV_COMMAND_INSPECTION:
  name: DEV_COMMAND storage and router inspection
  status: Active
  cross_references:
    - REQ-UI_INSPECTION
    - REQ-URL_TAGS_DISPLAY
    - REQ-PER_BOOKMARK_STORAGE_BACKEND
  rationale:
    why: Tests and debug panel can read current bookmark, tags for URL, storage backend, and storage key list
    problems_solved:
      - Cannot inspect stored state without manual steps
    benefits:
      - processDevCommand in MessageHandler; getStorageSnapshot in SW when DEBUG_HOVERBOARD_UI set
  implementation_approach:
    summary: DEV_COMMAND subcommands getCurrentBookmark, getTagsForUrl, getStorageBackendForUrl (message-handler); getStorageSnapshot (service worker, returns key names only)
  code_locations:
    files:
      - path: src/core/message-handler.js
      - path: src/core/service-worker.js
      - path: tests/utils/test-helpers.js
  traceability:
    requirements:
      - REQ-UI_INSPECTION
  detail_file: implementation-decisions/IMPL-DEV_COMMAND_INSPECTION.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Extracted from index to detail file
IMPL-DEBUG_PANEL:
  name: Debug panel and structured UI/message logging
  status: Active
  cross_references:
    - REQ-UI_INSPECTION
    - ARCH-UI_TESTABILITY
    - ai-principles.md
  rationale:
    why: Consistent DEBUG/TRACE labels for UI and message flow; optional in-extension view of last N actions and state
    problems_solved:
      - Ad-hoc console.log/debugLog scattered across message-handler, popup, content
    benefits:
      - debug-logger.js categories (ui, message, overlay, storage); debug panel shows inspector ring buffers and current tab state via DEV_COMMAND
  implementation_approach:
    summary: LOG_CATEGORIES in debug-logger; debugLogger.trace/debug in message-handler, PopupController, content-main; src/ui/debug/debug.html + debug.js (last actions, last messages, current bookmark/tags/backend)
  code_locations:
    files:
      - path: src/shared/debug-logger.js
      - path: src/core/message-handler.js
      - path: src/ui/popup/PopupController.js
      - path: src/features/content/content-main.js
      - path: src/ui/debug/debug.html
      - path: src/ui/debug/debug.js
  traceability:
    requirements:
      - REQ-UI_INSPECTION
  detail_file: implementation-decisions/IMPL-DEBUG_PANEL.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Extracted from index to detail file
IMPL-POPUP_BUNDLE:
  name: Popup bundle build
  status: Active
  cross_references:
    - REQ-EXTENSION_BUNDLED_ENTRY_POINTS
    - ARCH-EXTENSION_BUNDLED_ENTRY_POINTS
  rationale:
    why: Popup was loaded unbundled; its dependency chain (e.g. PopupController → TagService → PinboardService → fast-xml-parser) caused "Failed to resolve module specifier 'fast-xml-parser'" when opening the popup
    problems_solved:
      - Popup opening triggered dynamic import of pinboard-service.js (raw copy in dist) which contains bare import of fast-xml-parser
    benefits:
      - Popup entry is a single bundle with all dependencies inlined; no bare specifiers at runtime
  implementation_approach:
    summary: build:popup bundles src/ui/popup/popup.js to dist/src/ui/popup/popup.js; scripts/build.js runs build:popup and skips copying ui/popup/popup.js
  code_locations:
    files:
      - path: package.json
        description: build:popup script
      - path: scripts/build.js
        description: Run build:popup; skip ui/popup/popup.js in copyDir
  traceability:
    requirements:
      - REQ-EXTENSION_BUNDLED_ENTRY_POINTS
    architecture:
      - ARCH-EXTENSION_BUNDLED_ENTRY_POINTS
  detail_file: implementation-decisions/IMPL-POPUP_BUNDLE.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Extracted from index to detail file
IMPL-BADGE_REFRESH:
  name: Badge refresh on overlay and popup changes
  status: Active
  cross_references:
    - ARCH-BADGE
    - REQ-BADGE_INDICATORS
  rationale:
    why: Badge must reflect tag count and private/toread flags as soon as user changes them in overlay or popup
    problems_solved:
      - Badge not updating after overlay tag add/remove
      - Badge not updating after overlay or popup private/toread toggle
    benefits:
      - Immediate visual feedback
      - Consistent state across icon, overlay, and popup
  implementation_approach:
    summary: Service worker refreshes badge after saveTag, deleteTag, and saveBookmark when message succeeds
    details:
      - 'Chrome and Safari service workers: after processMessage success, if message type is saveTag, deleteTag, or saveBookmark, resolve tab (sender.tab or for saveBookmark query active tab) and call updateBadgeForTab(tab)'
      - Covers overlay-originated and popup-originated changes
  code_locations:
    files:
      - path: src/core/service-worker.js
        description: Chrome service worker handleMessage badge refresh
      - path: safari/src/core/service-worker.js
        description: Safari service worker handleMessage badge refresh
    functions:
      - name: handleMessage
        file: src/core/service-worker.js
        description: Calls updateBadgeForTab after saveTag/deleteTag/saveBookmark
  traceability:
    architecture:
      - ARCH-BADGE
    requirements:
      - REQ-BADGE_INDICATORS
    tests:
      - tests/unit/badge-refresh-service-worker.test.js
    code_annotations:
      - '[REQ-BADGE_INDICATORS] in service-worker.js'
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-BOOKMARK_STATE_SYNC
    composed_with:
      - IMPL-MESSAGE_HANDLING
      - IMPL-BOOKMARK_ROUTER
  essence_pseudocode: |
    After processMessage success for saveTag/deleteTag/saveBookmark: resolve tab (sender.tab or query active); updateBadgeForTab(tab).
  detail_file: implementation-decisions/IMPL-BADGE_REFRESH.yaml
  metadata:
    created:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-URL_TAGS_DISPLAY:
  name: URL Tags and Badge Display Module
  status: Active
  cross_references:
    - ARCH-URL_TAGS_DISPLAY
    - REQ-URL_TAGS_DISPLAY
    - REQ-BADGE_INDICATORS
    - REQ-PER_BOOKMARK_STORAGE_BACKEND
  rationale:
    why: Single source for tags-for-URL and badge display value; normalization at boundary so badge, popup, overlay use same contract
    problems_solved:
      - Popup showing no tags when badge correct; adding tag losing prior tags
      - Tags string vs array inconsistency across providers
      - Popup empty when no Pinboard auth although bookmark in local/file/sync
    benefits:
      - normalizeBookmarkForDisplay, getBookmarkForDisplay, getTagsForUrl, getBadgeDisplayValue in one module
      - Message handler and service worker use it; popup re-fetches and merges when adding/removing tag
      - getTagsForUrl message centralizes tag storage for tests and UI
  implementation_approach:
    summary: url-tags-manager.js; handleGetCurrentBookmark always uses router (no early return for no auth), normalizes, sets needsAuth when !hasAuth; GET_TAGS_FOR_URL message and handleGetTagsForUrl; popup getBookmarkData only null when blocked.
    details:
      - 'normalizeBookmarkForDisplay(bookmark): tags always array, required fields defaulted'
      - 'getBookmarkForDisplay(provider, url, title): async, returns normalized bookmark'
      - 'getTagsForUrl(provider, url): async, returns tags array'
      - 'getBadgeDisplayValue(bookmark, config): text, tagCount, isPrivate, isToRead, isBookmarked, title'
      - 'handleGetCurrentBookmark: use getBookmarkForDisplay(bookmarkProvider, targetUrl, data?.title); set normalized.needsAuth when !hasAuth'
      - 'handleSaveBookmark: previous tags from getTagsForUrl(bookmarkProvider, data.url) (same source as badge/popup)'
      - 'GET_TAGS_FOR_URL message and handleGetTagsForUrl(data): return { tags } from getTagsForUrl(bookmarkProvider, data.url)'
      - 'BookmarkRouter: _hasTags and _isEmptyBookmark use normalizeBookmarkForDisplay for tag shape'
      - 'PopupController getBookmarkData: resolve(null) only when bookmarkData.blocked; when needsAuth still return bookmark (with tags)'
      - 'PopupController: re-fetch before add/remove tag; validateBookmarkData normalizes tags to array'
  code_locations:
    files:
      - path: src/features/storage/url-tags-manager.js
        description: URL tags manager module
      - path: src/core/message-handler.js
        description: handleGetCurrentBookmark always from router; handleGetTagsForUrl
      - path: src/core/service-worker.js
        description: updateBadgeForTab normalizes bookmark
      - path: src/core/badge-manager.js
        description: calculateBadgeData uses getBadgeDisplayValue
      - path: src/ui/popup/PopupController.js
        description: getBookmarkData only null when blocked; re-fetch and merge on add/remove tag
      - path: src/features/storage/bookmark-router.js
        description: _hasTags and _isEmptyBookmark use normalizeBookmarkForDisplay
  traceability:
    architecture:
      - ARCH-URL_TAGS_DISPLAY
    requirements:
      - REQ-URL_TAGS_DISPLAY
      - REQ-BADGE_INDICATORS
    tests:
      - tests/unit/url-tags-manager.test.js
      - tests/unit/popup-live-data.test.js
      - tests/unit/message-handler-url-tags.test.js
      - tests/unit/bookmark-router.test.js
    code_annotations:
      - IMPL-URL_TAGS_DISPLAY
      - ARCH-URL_TAGS_DISPLAY
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-BADGE_REFRESH
    composed_with:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-BADGE_REFRESH
      - IMPL-MESSAGE_HANDLING
  essence_pseudocode: |
    normalizeBookmarkForDisplay; getBookmarkForDisplay; getTagsForUrl; getBadgeDisplayValue. Message handler/popup/router/badge use single source.
  detail_file: implementation-decisions/IMPL-URL_TAGS_DISPLAY.yaml
  metadata:
    created:
      date: '2026-02-17'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-LOCAL_BOOKMARKS_INDEX:
  name: Local Bookmarks Index Implementation
  status: Active
  cross_references:
    - ARCH-LOCAL_BOOKMARKS_INDEX
    - REQ-LOCAL_BOOKMARKS_INDEX
    - ARCH-STORAGE_INDEX_AND_ROUTER
  rationale:
    why: Implement full index of local and file bookmarks with Storage column, search, filter, sort, launch
    problems_solved:
      - No single view of local and file bookmarks
    benefits:
      - getAggregatedBookmarksForIndex (router aggregates local + file) with fallback getLocalBookmarksForIndex; table page with Storage column
  implementation_approach:
    summary: Index page sends getAggregatedBookmarksForIndex first (BookmarkRouter.getAllBookmarksForIndex), fallback getLocalBookmarksForIndex; bookmarks-table with Storage column (Local | File), search/filter/sort/launch; entry point from popup/options
    details:
      - 'MessageHandler: handleGetAggregatedBookmarksForIndex calls bookmarkProvider.getAllBookmarksForIndex() when available; handleGetLocalBookmarksForIndex uses LocalBookmarkService only (fallback)'
      - 'BookmarkRouter.getAllBookmarksForIndex(): aggregates localProvider.getAllBookmarks() and fileProvider.getAllBookmarks(), adds storage ''local''|''file'', merges and sorts by time desc'
      - 'src/ui/bookmarks-table/: HTML (search, filters, table with Storage column, empty state), JS (loadBookmarks uses aggregated then fallback, renderTableBody shows Storage, sort by storage), CSS (table, sort indicators)'
      - 'Popup: bookmarksIndexBtn emits openBookmarksIndex; PopupController.handleOpenBookmarksIndex opens tab. Options: bookmarks-index-link href set to extension URL'
  code_locations:
    files:
      - path: src/features/storage/local-bookmark-service.js
        description: getAllBookmarks() method
      - path: src/core/message-handler.js
        description: GET_AGGREGATED_BOOKMARKS_FOR_INDEX, GET_LOCAL_BOOKMARKS_FOR_INDEX, handleGetAggregatedBookmarksForIndex, handleGetLocalBookmarksForIndex
      - path: src/features/storage/bookmark-router.js
        description: getAllBookmarksForIndex() aggregates local + file with storage field
      - path: src/ui/bookmarks-table/bookmarks-table.html
        description: Index page layout
      - path: src/ui/bookmarks-table/bookmarks-table.js
        description: loadBookmarks, applySearchAndFilter, renderTableBody, setSort
      - path: src/ui/bookmarks-table/bookmarks-table.css
        description: Table and toolbar styles
      - path: src/ui/popup/popup.html
        description: bookmarksIndexBtn entry point
      - path: src/ui/popup/PopupController.js
        description: handleOpenBookmarksIndex
      - path: src/ui/popup/UIManager.js
        description: bookmarksIndexBtn click emits openBookmarksIndex
      - path: src/ui/options/options.html
        description: bookmarks-index-link in footer
      - path: src/ui/options/options.js
        description: bookmarksIndexLink href set in init()
    functions:
      - name: getAllBookmarks
        file: src/features/storage/local-bookmark-service.js
        description: Returns full normalized array of local bookmarks, sorted by time desc
      - name: handleGetLocalBookmarksForIndex
        file: src/core/message-handler.js
        description: Uses LocalBookmarkService, returns { bookmarks } (fallback)
      - name: getAllBookmarksForIndex
        file: src/features/storage/bookmark-router.js
        description: Aggregates local + file bookmarks with storage field, sorted by time desc
  traceability:
    architecture:
      - ARCH-LOCAL_BOOKMARKS_INDEX
      - ARCH-STORAGE_INDEX_AND_ROUTER
    requirements:
      - REQ-LOCAL_BOOKMARKS_INDEX
    tests:
      - tests/unit/message-handler-bookmarks-index.test.js
      - tests/unit/bookmarks-table-index.test.js
      - tests/unit/bookmarks-table-time.test.js
    code_annotations:
      - IMPL-LOCAL_BOOKMARKS_INDEX
  related_decisions:
    depends_on:
      - ARCH-LOCAL_BOOKMARKS_INDEX
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-BOOKMARK_ROUTER
    composed_with:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-LOCAL_BOOKMARKS_INDEX_EXPORT
      - IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT
  essence_pseudocode: |
    INPUT: none (page load); user actions (search, filter, sort, selection, export/move/delete/import)
    OUTPUT: displayed table of bookmarks with Storage column; filtered/sorted list
    DATA: allBookmarks (array with storage field), filteredBookmarks, selectedUrls (set), sortKey, timeColumnSource, timeDisplayMode

    ON page load:
      SEND getAggregatedBookmarksForIndex
      ON response: SET allBookmarks = response.bookmarks (each item has storage "local"|"file"|"sync")
      ON failure: SEND getLocalBookmarksForIndex; SET allBookmarks = response.bookmarks with storage "local"
      applySearchAndFilter()

    applySearchAndFilter():
      filteredBookmarks = allBookmarks
      APPLY stores filter (matchStoresFilter, getAllowedStores)
      APPLY search (text)
      APPLY show-only (tags, toread, private, time range; getShowOnlyDefaultState for Clear)
      APPLY exclude tags (matchExcludeTags)
      SORT by sortKey (e.g. time desc)
      renderTableBody(filteredBookmarks); updateRowCount()

    Entry points:
      Popup: bookmarksIndexBtn click -> openBookmarksIndex -> open tab to bookmarks-table.html
      Options: bookmarks-index-link href -> extension URL to bookmarks-table.html
  detail_file: implementation-decisions/IMPL-LOCAL_BOOKMARKS_INDEX.yaml
  metadata:
    created:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
    last_validated:
      date: 2026-02-13T00:00:00.000Z
      validator: AI Agent
      result: pass
IMPL-LOCAL_BOOKMARKS_INDEX_EXPORT:
  name: Local Bookmarks Index Export Implementation
  status: Active
  cross_references:
    - ARCH-LOCAL_BOOKMARKS_INDEX_EXPORT
    - REQ-LOCAL_BOOKMARKS_INDEX_EXPORT
  rationale:
    why: Implement export UI and download using existing in-memory data
    problems_solved:
      - No export path for index data
    benefits:
      - 'Two buttons: Export all, Export displayed; CSV download'
  implementation_approach:
    summary: Export controls in bookmarks-table toolbar; exportBookmarks(scope) with scope 'all' or 'displayed'; serialize to CSV including Storage column; Blob + object URL + <a download> click; revoke URL
    details:
      - 'bookmarks-table.html: Export all and Export displayed buttons in toolbar'
      - 'bookmarks-table.js: elements.exportAll, elements.exportDisplayed; exportBookmarks(scope); get allBookmarks or filteredBookmarks (local + file with storage field); build CSV (header + rows including Storage Local|File, quoted fields); filename hoverboard-bookmarks-{all|displayed}-{date}.csv; trigger download'
      - Disable Export displayed when filteredBookmarks.length === 0; disable Export all when allBookmarks.length === 0
  code_locations:
    files:
      - path: src/ui/bookmarks-table/bookmarks-table.html
        description: Export all / Export displayed buttons
      - path: src/ui/bookmarks-table/bookmarks-table.js
        description: exportBookmarks(scope), CSV build, download trigger, init bindings
      - path: src/ui/bookmarks-table/bookmarks-table.css
        description: Export button styles (if any)
    functions:
      - name: exportBookmarks
        file: src/ui/bookmarks-table/bookmarks-table.js
        description: Exports given scope (all|displayed) to CSV and triggers download
  traceability:
    architecture:
      - ARCH-LOCAL_BOOKMARKS_INDEX_EXPORT
    requirements:
      - REQ-LOCAL_BOOKMARKS_INDEX_EXPORT
    tests: []
    code_annotations:
      - IMPL-LOCAL_BOOKMARKS_INDEX_EXPORT
  related_decisions:
    depends_on:
      - IMPL-LOCAL_BOOKMARKS_INDEX
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARKS_INDEX
    composed_with:
      - IMPL-LOCAL_BOOKMARKS_INDEX
  essence_pseudocode: |
    exportBookmarks(scope): source = allBookmarks|filteredBookmarks|selected; buildCsv(source); Blob+object URL+<a download>; revoke. updateExportButtonState() disables Export selected when no selection.
  detail_file: implementation-decisions/IMPL-LOCAL_BOOKMARKS_INDEX_EXPORT.yaml
  metadata:
    created:
      date: 2026-02-13T00:00:00.000Z
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
    last_validated:
      date: 2026-02-13T00:00:00.000Z
      validator: AI Agent
      result: pass
IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT:
  name: Local Bookmarks Index Import Implementation
  status: Active
  cross_references:
    - ARCH-LOCAL_BOOKMARKS_INDEX_IMPORT
    - REQ-LOCAL_BOOKMARKS_INDEX_IMPORT
  rationale:
    why: Implement import UI and parse + save loop using existing saveBookmark
    problems_solved:
      - No import path for index data
    benefits:
      - File input + only new / overwrite; Import to Local | File | Sync; result message
  implementation_approach:
    summary: Import row in actions-below-table; parseCsv in bookmarks-table-csv.js; file input + Import button; only new filters by allBookmarks; per-row saveBookmark; loadBookmarks + result
    details:
      - bookmarks-table.html: hidden file input, Import button, radios, Import to dropdown
      - bookmarks-table.js: runImport on file change; parse CSV/JSON; filter if only new; sendMessage saveBookmark; loadBookmarks; show result
      - bookmarks-table-csv.js: parseCsv(csvString) returning array of bookmark-like objects
  code_locations:
    files:
      - path: src/ui/bookmarks-table/bookmarks-table.html
        description: Import row (file input, button, radios, dropdown)
      - path: src/ui/bookmarks-table/bookmarks-table.js
        description: runImport, file change handler, result message
      - path: src/ui/bookmarks-table/bookmarks-table-csv.js
        description: parseCsv for import
    functions:
      - name: parseCsv
        file: src/ui/bookmarks-table/bookmarks-table-csv.js
        description: Parse CSV string to array of bookmark objects (export format)
      - name: runImport
        file: src/ui/bookmarks-table/bookmarks-table.js
        description: Parse file, filter if only new, send saveBookmark per row, refresh, show result
  traceability:
    architecture:
      - ARCH-LOCAL_BOOKMARKS_INDEX_IMPORT
    requirements:
      - REQ-LOCAL_BOOKMARKS_INDEX_IMPORT
    tests:
      - tests/unit/bookmarks-table-import.test.js
    code_annotations:
      - IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT
  related_decisions:
    depends_on:
      - IMPL-LOCAL_BOOKMARKS_INDEX
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARKS_INDEX_EXPORT
    composed_with:
      - IMPL-LOCAL_BOOKMARKS_INDEX
      - IMPL-LOCAL_BOOKMARKS_INDEX_EXPORT
      - IMPL-BOOKMARK_ROUTER
  essence_pseudocode: |
    runImport(file): parseImportFile -> rows; if Only new filter by allBookmarks; for each row send saveBookmark({ ...row, preferredBackend }); count imported/skipped/failed; loadBookmarks(); show result.
  detail_file: implementation-decisions/IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT.yaml
  metadata:
    created:
      date: '2026-02-18'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
    last_validated:
      date: '2026-02-18'
      validator: AI Agent
      result: pass
IMPL-LOCAL_BOOKMARKS_INDEX_ADD_TAGS:
  name: Local Bookmarks Index Add Tags to Selected Implementation
  status: Active
  cross_references:
    - ARCH-LOCAL_BOOKMARKS_INDEX_ADD_TAGS
    - REQ-LOCAL_BOOKMARKS_INDEX_ADD_TAGS
  rationale:
    why: Implement add-tags UI and pure helpers (parseTagsInput, mergeTags); reuse saveBookmark.
    problems_solved:
      - No add-tags control or tag-merge logic for index
    benefits:
      - parseTagsInput, mergeTags in bookmarks-table-filter.js; add-tags row in HTML; addTagsToSelected in bookmarks-table.js
  implementation_approach:
    summary: parseTagsInput and mergeTags in filter module; add-tags row; addTagsToSelected sends saveBookmark per selected with merged tags and preferredBackend; refresh and clear.
    details: []
  code_locations:
    files:
      - path: src/ui/bookmarks-table/bookmarks-table-filter.js
        description: parseTagsInput, mergeTags
      - path: src/ui/bookmarks-table/bookmarks-table.html
        description: Add tags row
      - path: src/ui/bookmarks-table/bookmarks-table.js
        description: addTagsToSelected, elements, updateMoveControlsState
    functions:
      - name: parseTagsInput
        file: src/ui/bookmarks-table/bookmarks-table-filter.js
      - name: mergeTags
        file: src/ui/bookmarks-table/bookmarks-table-filter.js
      - name: addTagsToSelected
        file: src/ui/bookmarks-table/bookmarks-table.js
  traceability:
    architecture:
      - ARCH-LOCAL_BOOKMARKS_INDEX_ADD_TAGS
    requirements:
      - REQ-LOCAL_BOOKMARKS_INDEX_ADD_TAGS
    tests:
      - tests/unit/bookmarks-table-index.test.js
    code_annotations:
      - IMPL-LOCAL_BOOKMARKS_INDEX_ADD_TAGS
  related_decisions:
    depends_on:
      - IMPL-LOCAL_BOOKMARKS_INDEX
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT
    composed_with:
      - IMPL-LOCAL_BOOKMARKS_INDEX
      - IMPL-BOOKMARK_ROUTER
  essence_pseudocode: |
    parseTagsInput(raw): empty -> []; split comma, trim, filter empty, dedupe case-insensitive. mergeTags(existing, new): merge with case-insensitive dedupe. addTagsToSelected: parse input; for each selected URL merge tags; saveBookmark({ ...bookmark, tags: merged, preferredBackend }); loadBookmarks(); clear input and selection.
  detail_file: implementation-decisions/IMPL-LOCAL_BOOKMARKS_INDEX_ADD_TAGS.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: New implementation for Add tags to selected
    last_validated:
      date: '2026-02-20'
      validator: AI Agent
      result: pass
IMPL-LOCAL_BOOKMARKS_INDEX_REGEX_REPLACE:
  name: Local Bookmarks Index Regex Find-and-Replace Implementation
  status: Active
  cross_references:
    - ARCH-LOCAL_BOOKMARKS_INDEX_REGEX_REPLACE
    - REQ-LOCAL_BOOKMARKS_INDEX_REGEX_REPLACE
  rationale:
    why: Implement regex-replace UI and pure helper applyRegexReplace; reuse saveBookmark and selectionStillVisible.
    problems_solved:
      - No regex replace control for index
    benefits:
      - applyRegexReplace in bookmarks-table-filter.js; regex-replace row in HTML; regexReplaceSelected in bookmarks-table.js
  implementation_approach:
    summary: applyRegexReplace in filter module; regex-replace row with inputs, checkboxes, Replace button; regexReplaceSelected validates regex, applyRegexReplace per selected, saveBookmark, refresh, selectionStillVisible.
    details: []
  code_locations:
    files:
      - path: src/ui/bookmarks-table/bookmarks-table-filter.js
        description: applyRegexReplace
      - path: src/ui/bookmarks-table/bookmarks-table.html
        description: Regex replace row
      - path: src/ui/bookmarks-table/bookmarks-table.js
        description: regexReplaceSelected, elements, updateMoveControlsState
    functions:
      - name: applyRegexReplace
        file: src/ui/bookmarks-table/bookmarks-table-filter.js
      - name: regexReplaceSelected
        file: src/ui/bookmarks-table/bookmarks-table.js
  traceability:
    architecture:
      - ARCH-LOCAL_BOOKMARKS_INDEX_REGEX_REPLACE
    requirements:
      - REQ-LOCAL_BOOKMARKS_INDEX_REGEX_REPLACE
    tests:
      - tests/unit/bookmarks-table-index.test.js
    code_annotations:
      - IMPL-LOCAL_BOOKMARKS_INDEX_REGEX_REPLACE
  related_decisions:
    depends_on:
      - IMPL-LOCAL_BOOKMARKS_INDEX
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARKS_INDEX_ADD_TAGS
    composed_with:
      - IMPL-LOCAL_BOOKMARKS_INDEX
      - IMPL-BOOKMARK_ROUTER
  essence_pseudocode: |
    applyRegexReplace(bookmark, patternStr, replacementStr, options): try RegExp(patternStr,'g'); catch return error; for each option field replace; return payload. regexReplaceSelected: read inputs/checkboxes; validate regex; for each selected applyRegexReplace and saveBookmark; loadBookmarks; selectionStillVisible; render.
  detail_file: implementation-decisions/IMPL-LOCAL_BOOKMARKS_INDEX_REGEX_REPLACE.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: New implementation for Regex find-and-replace on selected
    last_validated:
      date: '2026-02-20'
      validator: AI Agent
      result: pass
IMPL-BROWSER_BOOKMARK_IMPORT:
  name: Browser Bookmark Import Implementation
  status: Active
  cross_references:
    - ARCH-BROWSER_BOOKMARK_IMPORT
    - REQ-BROWSER_BOOKMARK_IMPORT
  rationale:
    why: Implement browser bookmark import page with getTree, flatten, filters, selection, conflict resolution, tags, saveBookmark loop.
    problems_solved:
      - No UI or logic for importing browser bookmarks into Hoverboard
    benefits:
      - browser-bookmark-import.html/.js/.css; getTree + flatten; search + folder filter; table; conflict mode; folder + extra tags; Import to; result message
  implementation_approach:
    summary: src/ui/browser-bookmark-import/ with HTML, JS (loadBrowserBookmarks, flattenTree, runImport), CSS; popup and options entry.
    details: []
  code_locations:
    files:
      - src/ui/browser-bookmark-import/browser-bookmark-import.html
      - src/ui/browser-bookmark-import/browser-bookmark-import.js
      - src/ui/browser-bookmark-import/browser-bookmark-import.css
    functions:
      - flattenTree
      - loadBrowserBookmarks
      - runImport
  traceability:
    architecture:
      - ARCH-BROWSER_BOOKMARK_IMPORT
    requirements:
      - REQ-BROWSER_BOOKMARK_IMPORT
    tests:
      - tests/unit/browser-bookmark-import.test.js
    code_annotations:
      - IMPL-BROWSER_BOOKMARK_IMPORT
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARKS_INDEX
      - IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT
    composed_with:
      - IMPL-LOCAL_BOOKMARKS_INDEX
      - IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT
      - IMPL-BOOKMARK_ROUTER
  essence_pseudocode: |
    ON load: getTree -> flattenTree -> allBookmarks. runImport: existingByUrl = getAggregatedBookmarksForIndex; for each selected build payload; Skip/Overwrite/Merge; saveBookmark per row; show imported/skipped/failed.
  detail_file: implementation-decisions/IMPL-BROWSER_BOOKMARK_IMPORT.yaml
  metadata:
    created:
      date: '2026-02-18'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
    last_validated:
      date: '2026-02-18'
      validator: AI Agent
      result: pass
IMPL-CONFIG_STRUCT:
  name: Configuration Structure
  status: Template
  cross_references:
    - ARCH-CONFIG_STRUCTURE
    - REQ-CONFIGURATION
  rationale:
    why: Why this configuration structure was chosen
    problems_solved:
      - Problem 1
    benefits:
      - Benefit 1
  implementation_approach:
    summary: Configuration structure implementation approach
    details:
      - Specific technical detail 1
      - Code structure or pattern
      - API design decision
  code_locations:
    files:
      - path: path/to/config.ext
        description: Configuration implementation
    functions:
      - name: loadConfig
        file: path/to/config.ext
        description: Configuration loading logic
  traceability:
    architecture:
      - ARCH-CONFIG_STRUCTURE
    requirements:
      - REQ-CONFIGURATION
    tests:
      - testConfiguration_IMPL_CONFIG_STRUCT
    code_annotations:
      - IMPL-CONFIG_STRUCT
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
  detail_file: implementation-decisions/IMPL-CONFIG_STRUCT.yaml
  metadata:
    created:
      date: YYYY-MM-DD
      author: agent/contributor
    last_updated:
      date: YYYY-MM-DD
      author: agent/contributor
      reason: Initial creation
    last_validated:
      date: YYYY-MM-DD
      validator: agent/contributor
      result: pass
IMPL-EXAMPLE_IMPLEMENTATION:
  name: Core Implementation Example
  status: Template
  cross_references:
    - ARCH-EXAMPLE_DECISION
    - REQ-EXAMPLE_FEATURE
  rationale:
    why: Why this implementation approach was chosen
    problems_solved:
      - Problem 1 that implementation solves
    benefits:
      - Benefit 1 of implementation
  implementation_approach:
    summary: Main implementation approach
    details:
      - Specific technical detail 1
      - Code structure or pattern
      - API design decision
  code_locations:
    files:
      - path: path/to/implementation.ext
        description: Main implementation
        lines:
          - 10
          - 50
    functions:
      - name: exampleFunction
        file: path/to/implementation.ext
        description: What it does
  traceability:
    architecture:
      - ARCH-EXAMPLE_DECISION
    requirements:
      - REQ-EXAMPLE_FEATURE
    tests:
      - testFeatureName_REQ_EXAMPLE_FEATURE
    code_annotations:
      - IMPL-EXAMPLE_IMPLEMENTATION
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
  detail_file: implementation-decisions/IMPL-EXAMPLE_IMPLEMENTATION.yaml
  metadata:
    created:
      date: YYYY-MM-DD
      author: agent/contributor
    last_updated:
      date: YYYY-MM-DD
      author: agent/contributor
      reason: Initial creation
    last_validated:
      date: YYYY-MM-DD
      validator: agent/contributor
      result: pass
IMPL-ERROR_HANDLING:
  name: Error Handling Implementation
  status: Template
  cross_references:
    - ARCH-ERROR_HANDLING
    - REQ-ERROR_HANDLING
  rationale:
    why: Why this error handling implementation was chosen
    problems_solved:
      - Problem 1
    benefits:
      - Benefit 1
  implementation_approach:
    summary: Error handling implementation approach
    details:
      - Specific error handling pattern
      - Error propagation strategy
      - Error logging and reporting
  code_locations:
    files:
      - path: path/to/error_handler.ext
        description: Error handling implementation
    functions:
      - name: handleError
        file: path/to/error_handler.ext
        description: Error handling logic
  traceability:
    architecture:
      - ARCH-ERROR_HANDLING
    requirements:
      - REQ-ERROR_HANDLING
    tests:
      - testErrorHandling_IMPL_ERROR_HANDLING
    code_annotations:
      - IMPL-ERROR_HANDLING
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
  detail_file: implementation-decisions/IMPL-ERROR_HANDLING.yaml
  metadata:
    created:
      date: YYYY-MM-DD
      author: agent/contributor
    last_updated:
      date: YYYY-MM-DD
      author: agent/contributor
      reason: Initial creation
    last_validated:
      date: YYYY-MM-DD
      validator: agent/contributor
      result: pass
IMPL-TESTING:
  name: Testing Implementation
  status: Template
  cross_references:
    - ARCH-TESTING_STRATEGY
  rationale:
    why: Why this testing implementation was chosen
    problems_solved:
      - Problem 1
    benefits:
      - Benefit 1
  implementation_approach:
    summary: Testing implementation approach
    details:
      - Unit testing implementation details
      - Integration testing implementation details
      - Test utilities and helpers
      - Test coverage tools
  code_locations:
    files:
      - path: '*_test.ext'
        description: Test files
    functions:
      - name: setupTestEnvironment
        file: test_helpers.ext
        description: Test setup logic
  traceability:
    architecture:
      - ARCH-TESTING_STRATEGY
    requirements:
      - REQ-*
    tests:
      - All test files implement this strategy
    code_annotations:
      - IMPL-TESTING
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
  detail_file: implementation-decisions/IMPL-TESTING.yaml
  metadata:
    created:
      date: YYYY-MM-DD
      author: agent/contributor
    last_updated:
      date: YYYY-MM-DD
      author: agent/contributor
      reason: Initial creation
    last_validated:
      date: YYYY-MM-DD
      validator: agent/contributor
      result: pass
IMPL-CODE_STYLE:
  name: Code Style and Conventions
  status: Active
  cross_references:
    - ARCH-CODE_QUALITY
    - REQ-CODE_QUALITY
  rationale:
    why: Enforce consistent JavaScript style and quality via ESLint 10 flat config (Standard-style preset) and avoid build failure on moderate audit findings in tooling deps
    problems_solved:
      - ESLint 10 removes eslintrc; flat config only with native preset
      - Build failing on moderate vulnerabilities in tooling deps with no safe fix
    benefits:
      - Single eslint.config.mjs; @eslinter/eslint-config-standard; ignores in config
      - security:check uses --audit-level=high; overrides.minimatch and test-exclude fix HIGH and deprecated transitives; Jest 30 stays secure
  implementation_approach:
    summary: ESLint 10 flat config, @eslinter/eslint-config-standard, Node >= 20.19.0, security audit level; minimatch and test-exclude overrides
    details:
      - 'eslint.config.mjs: globalIgnores, spread @eslinter/eslint-config-standard, files src/**/*.js, languageOptions (ecmaVersion 2022, globals.browser), six rule overrides'
      - package.json engines.node >= 20.19.0
      - 'package.json security:check: npm audit --audit-level=high'
      - 'package.json overrides.minimatch ^10.2.1, test-exclude ^7.0.1 (Jest 30; fixes high ReDoS and deprecated glob 7/inflight)'
  code_locations:
    files:
      - path: .editorconfig
        description: Editor configuration
      - path: .prettierrc
        description: Code formatter configuration (or similar)
      - path: eslint.config.mjs
        description: ESLint 10 flat config (@eslinter/eslint-config-standard)
      - path: package.json
        description: engines.node, scripts, overrides.minimatch and test-exclude
  traceability:
    architecture:
      - ARCH-CODE_QUALITY
    requirements:
      - REQ-CODE_QUALITY
    tests:
      - npm run lint; npm run lint:fix; npm run validate
    code_annotations:
      - All source files follow these conventions
  related_decisions:
    depends_on:
      - ARCH-CODE_QUALITY
    supersedes: []
    see_also:
      - REQ-MAINTAINABILITY
  detail_file: implementation-decisions/IMPL-CODE_STYLE.yaml
  metadata:
    created:
      date: YYYY-MM-DD
      author: agent/contributor
    last_updated:
      date: '2026-02-19'
      author: agent
      reason: ESLint 10; @eslinter/eslint-config-standard; Node 20+; overrides minimatch and test-exclude for Jest 30 security
    last_validated:
      date: '2026-02-19'
      validator: agent
      result: pass
IMPL-PINBOARD_POSTS_ADD_ENCODING:
  name: Pinboard posts/add query parameter encoding
  status: Active
  cross_references:
    - IMPL-PINBOARD_API
    - IMPL-TAG_SYSTEM
  rationale:
    why: 'Store-tag API calls fail when tags contain #, +, or . unless query parameters are percent-encoded'
    problems_solved:
      - 'Unencoded # breaks the request URL (fragment delimiter); auth_token and other params can be lost'
      - Unencoded + is interpreted as space in application/x-www-form-urlencoded
      - Pinboard API requires all arguments to be URL-encoded
    benefits:
      - 'Tags (and description, extended, url) with #, +, ., &, = etc. can be stored without breaking the API call'
      - Explicit encodeURIComponent guarantees correct encoding across extension and Safari runtimes
  implementation_approach:
    summary: Build posts/add query string with encodeURIComponent for every user-controlled parameter value
    details:
      - buildSaveParams builds key=encodeURIComponent(value) pairs and join('&') instead of URLSearchParams
      - Applied to url, description, extended, tags, shared, toread in src and safari pinboard-service
      - Same logic in safari/src/features/pinboard/pinboard-service.js for consistency
  code_locations:
    files:
      - path: src/features/pinboard/pinboard-service.js
        description: buildSaveParams uses encodeURIComponent for all params
      - path: safari/src/features/pinboard/pinboard-service.js
        description: Mirror buildSaveParams encoding
    functions:
      - name: buildSaveParams
        file: src/features/pinboard/pinboard-service.js
        description: Builds encoded query string for posts/add
  traceability:
    architecture: []
    requirements: []
    tests:
      - 'tag-storage.test.js: should save tag with special characters (#, +, .) with percent-encoded URL'
    code_annotations:
      - PIN-003 (parameter encoding comment in buildSaveParams)
  related_decisions:
    depends_on:
      - IMPL-PINBOARD_API
    supersedes: []
    see_also:
      - IMPL-TAG_SYSTEM
  detail_file: implementation-decisions/IMPL-PINBOARD_POSTS_ADD_ENCODING.yaml
  metadata:
    created:
      date: '2026-02-13'
      author: AI Agent
    last_updated:
      date: '2026-02-13'
      author: AI Agent
      reason: 'Bug fix: tag storage fails when special characters in tag'
IMPL-RECENT_TAGS_POPUP_REFRESH:
  name: Recent Tags refresh on every popup display
  status: Active
  cross_references:
    - REQ-RECENT_TAGS_SYSTEM
    - ARCH-POPUP_SESSION
  rationale:
    why: Ensure Recent Tags list is refreshed whenever the popup is displayed, including when the document is reused without full reload
    problems_solved:
      - Popup might be shown again without loadInitialData running (e.g. document reuse)
      - Recent Tags could appear stale after saving a tag in another window
    benefits:
      - Recent Tags always reflect service worker shared memory when user sees the popup
      - Tags saved in one window appear in Recent Tags when popup is displayed in any window
  implementation_approach:
    summary: Add document.visibilitychange listener in PopupController that calls loadRecentTags() when document becomes visible and popup is initialized
    details:
      - Listener registered in setupAutoRefresh() alongside existing focus listener
      - 'Guard: only run when document.visibilityState === ''visible'', isInitialized, and !isLoading'
      - loadRecentTags() fetches from service worker (getRecentBookmarks) and updates UI via uiManager.updateRecentTags()
  code_locations:
    files:
      - path: src/ui/popup/PopupController.js
        description: visibilitychange listener and loadRecentTags call
    functions:
      - name: setupAutoRefresh
        file: src/ui/popup/PopupController.js
        description: Registers visibilitychange listener for Recent Tags refresh
  traceability:
    architecture:
      - ARCH-POPUP_SESSION
    requirements:
      - REQ-RECENT_TAGS_SYSTEM
    tests: []
    code_annotations:
      - IMPL-RECENT_TAGS_POPUP_REFRESH
      - IMMUTABLE-REQ-TAG-003
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-TAG_SYSTEM
  detail_file: implementation-decisions/IMPL-RECENT_TAGS_POPUP_REFRESH.yaml
  metadata:
    created:
      date: '2026-02-13'
      author: AI Agent
    last_updated:
      date: '2026-02-13'
      author: AI Agent
      reason: Recent Tags refresh on every popup display per plan
    last_validated:
      date: '2026-02-13'
      validator: AI Agent
      result: pass
IMPL-LOCAL_BOOKMARK_SERVICE:
  name: Local Bookmark Service
  status: Active
  cross_references:
    - REQ-STORAGE_MODE_DEFAULT
    - ARCH-LOCAL_STORAGE_PROVIDER
    - ARCH-STORAGE
  rationale:
    why: Implement bookmark provider contract using chrome.storage.local for local-only mode
    problems_solved:
      - No local bookmark storage implementation
    benefits:
      - 'Default storage mode is local (ConfigManager default storageMode: ''local''); Pinboard selectable in Options'
      - Same method signatures as PinboardService (getBookmarkForUrl, saveBookmark, deleteBookmark, saveTag, deleteTag, getRecentBookmarks, testConnection)
      - Bookmarks keyed by URL in hoverboard_local_bookmarks; recent by time sort
  implementation_approach:
    summary: LocalBookmarkService class in src/features/storage/local-bookmark-service.js; TagService integration for tag tracking.
    details:
      - 'Default provider is local (ConfigManager getDefaultConfiguration().storageMode: ''local'')'
      - 'Storage key: hoverboard_local_bookmarks (object keyed by URL)'
      - Normalized bookmark shape matches PinboardService (url, description, extended, tags, time, shared, toread, hash)
      - trackBookmarkTags and extractTagsFromBookmarkData for recent-tag integration
  code_locations:
    files:
      - path: src/features/storage/local-bookmark-service.js
        description: LocalBookmarkService implementation
  traceability:
    architecture:
      - ARCH-LOCAL_STORAGE_PROVIDER
    requirements:
      - REQ-STORAGE_MODE_DEFAULT
    tests: []
    code_annotations:
      - IMPL-LOCAL_BOOKMARK_SERVICE
  related_decisions:
    depends_on:
      - ARCH-LOCAL_STORAGE_PROVIDER
    supersedes: []
    see_also:
      - ARCH-STORAGE
    composed_with:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-STORAGE_INDEX
  detail_file: implementation-decisions/IMPL-LOCAL_BOOKMARK_SERVICE.yaml
  metadata:
    created:
      date: '2026-02-13'
      author: AI Agent
    last_updated:
      date: '2026-02-13'
      author: AI Agent
      reason: Local storage mode implementation per plan
    last_validated:
      date: '2026-02-13'
      validator: AI Agent
      result: pass
IMPL-FILE_BOOKMARK_SERVICE:
  name: File Bookmark Service
  status: Active
  cross_references:
    - REQ-FILE_BOOKMARK_STORAGE
    - ARCH-FILE_BOOKMARK_PROVIDER
  rationale:
    why: Implement file-based bookmark provider with same contract as Local/Pinboard; testable via adapter abstraction
    problems_solved:
      - No file-based storage implementation
    benefits:
      - 'FileBookmarkStorageAdapter: readBookmarksFile(), writeBookmarksFile(data); mockable for tests'
      - 'FileBookmarkService: getBookmarkForUrl, getRecentBookmarks, saveBookmark, deleteBookmark, saveTag, deleteTag, testConnection'
      - 'File format: { version: 1, bookmarks: { url: bookmark } }; same bookmark shape as local'
  implementation_approach:
    summary: FileBookmarkService in src/features/storage/file-bookmark-service.js; adapter interface; in-memory adapter for tests; real adapter (file I/O) for production.
    details:
      - 'Adapter methods: readBookmarksFile() -> Promise<{ version, bookmarks }>, writeBookmarksFile(data) -> Promise<void>'
      - Normalize URL and bookmark shape to match LocalBookmarkService (url, description, extended, tags, time, shared, toread, hash)
      - 'Filename in directory: hoverboard-bookmarks.json'
  code_locations:
    files:
      - path: src/features/storage/file-bookmark-service.js
        description: FileBookmarkService and adapter usage
      - path: src/features/storage/file-bookmark-storage-adapter.js
        description: Adapter interface and in-memory implementation
  traceability:
    architecture:
      - ARCH-FILE_BOOKMARK_PROVIDER
    requirements:
      - REQ-FILE_BOOKMARK_STORAGE
    tests:
      - tests/unit/file-bookmark-service.test.js
    code_annotations:
      - IMPL-FILE_BOOKMARK_SERVICE
  related_decisions:
    depends_on:
      - ARCH-FILE_BOOKMARK_PROVIDER
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARK_SERVICE
    composed_with:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-STORAGE_INDEX
      - IMPL-LOCAL_BOOKMARK_SERVICE
  essence_pseudocode: |
    INPUT: url (string), bookmark data (for save), tag data (for saveTag/deleteTag), count (for getRecentBookmarks)
    OUTPUT: bookmark object or list of bookmarks or success/error; shape matches provider contract
    DATA: adapter (readBookmarksFile, writeBookmarksFile); file shape = { version: 1, bookmarks: map url -> bookmark }

    LOAD bookmarks from file:
      data = adapter.readBookmarksFile()
      RETURN data.bookmarks (or {} if missing); in-memory map urlNorm -> bookmark

    getBookmarkForUrl(url):
      bookmarks = LOAD bookmarks from file
      urlNorm = normalize(url)
      RETURN bookmarks[urlNorm] or null

    saveBookmark(data):
      bookmarks = LOAD bookmarks from file
      urlNorm = normalize(data.url)
      bookmarks[urlNorm] = merge(data into bookmark shape with url, description, extended, tags, time, shared, toread, hash)
      adapter.writeBookmarksFile({ version: 1, bookmarks })
      RETURN { success: true }

    deleteBookmark(url):
      bookmarks = LOAD bookmarks from file
      REMOVE bookmarks[normalize(url)]
      adapter.writeBookmarksFile({ version: 1, bookmarks })
      RETURN { success: true }

    saveTag(data), deleteTag(data):
      bookmark = getBookmarkForUrl(data.url); update tags; saveBookmark(bookmark) or equivalent
      RETURN { success: true }

    getRecentBookmarks(count):
      bookmarks = LOAD bookmarks from file
      list = values(bookmarks)
      SORT list BY time DESCENDING
      RETURN list[0..count-1]
  detail_file: implementation-decisions/IMPL-FILE_BOOKMARK_SERVICE.yaml
  metadata:
    created:
      date: '2026-02-14'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
    last_validated:
      date: '2026-02-14'
      validator: AI Agent
      result: pass
IMPL-STORAGE_INDEX:
  name: Storage Index
  status: Active
  cross_references:
    - REQ-PER_BOOKMARK_STORAGE_BACKEND
    - ARCH-STORAGE_INDEX_AND_ROUTER
  rationale:
    why: Persist per-URL storage backend (pinboard|local|file) in chrome.storage.local
    problems_solved:
      - Need to know which backend owns each URL
    benefits:
      - getIndex(), setBackendForUrl(url, backend), getBackendForUrl(url), removeUrl(url)
      - 'Key: hoverboard_storage_index'
  implementation_approach:
    summary: StorageIndex class in src/features/storage/storage-index.js; chrome.storage.local.
    details:
      - 'Index shape: { url: ''pinboard''|''local''|''file'' }'
      - 'Migration: on first use, seed from LocalBookmarkService.getAllBookmarks() -> setBackendForUrl(url, ''local'')'
  code_locations:
    files:
      - path: src/features/storage/storage-index.js
        description: StorageIndex implementation
  traceability:
    architecture:
      - ARCH-STORAGE_INDEX_AND_ROUTER
    requirements:
      - REQ-PER_BOOKMARK_STORAGE_BACKEND
    tests:
      - tests/unit/storage-index.test.js
    code_annotations:
      - IMPL-STORAGE_INDEX
  related_decisions:
    depends_on:
      - ARCH-STORAGE_INDEX_AND_ROUTER
    supersedes: []
    see_also:
      - IMPL-BOOKMARK_ROUTER
    composed_with:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-LOCAL_BOOKMARK_SERVICE
  detail_file: implementation-decisions/IMPL-STORAGE_INDEX.yaml
  metadata:
    created:
      date: '2026-02-14'
      author: AI Agent
    last_updated:
      date: '2026-02-14'
      author: AI Agent
      reason: Storage index per plan
IMPL-BOOKMARK_ROUTER:
  name: Bookmark Router
  status: Active
  cross_references:
    - REQ-PER_BOOKMARK_STORAGE_BACKEND
    - REQ-STORAGE_MODE_DEFAULT
    - REQ-MOVE_BOOKMARK_STORAGE_UI
    - ARCH-STORAGE_INDEX_AND_ROUTER
    - IMPL-MOVE_BOOKMARK_UI
  rationale:
    why: Delegate bookmark operations to correct provider per URL using storage index; aggregate getRecentBookmarks; save follows popup UI selection when preferredBackend is sent
    problems_solved:
      - Single provider cannot support per-bookmark backends
      - Save not following highlighted storage when creating bookmark from popup
    benefits:
      - getBookmarkForUrl, saveBookmark, deleteBookmark, saveTag, deleteTag delegate by URL
      - saveBookmark honors data.preferredBackend (popup UI selection) so save follows the highlight (REQ-STORAGE_MODE_DEFAULT, REQ-MOVE_BOOKMARK_STORAGE_UI)
      - getRecentBookmarks aggregates pinboard + local + file + sync, sorted by time
      - getStorageBackendForUrl(url), moveBookmarkToStorage(url, targetBackend) for move UI
  implementation_approach:
    summary: BookmarkRouter in src/features/storage/bookmark-router.js; holds pinboardProvider, localProvider, fileProvider, syncProvider, storageIndex, defaultStorageMode.
    details:
      - 'Resolve provider: (valid data.preferredBackend) || getBackendForUrl(url) || defaultStorageMode; map to one of four providers (pinboard, local, file, sync)'
      - 'moveBookmarkToStorage: get bookmark from current backend, save to target, delete from source, update index'
  code_locations:
    files:
      - path: src/features/storage/bookmark-router.js
        description: BookmarkRouter implementation
  traceability:
    architecture:
      - ARCH-STORAGE_INDEX_AND_ROUTER
    requirements:
      - REQ-PER_BOOKMARK_STORAGE_BACKEND
      - REQ-STORAGE_MODE_DEFAULT
      - REQ-MOVE_BOOKMARK_STORAGE_UI
    tests:
      - tests/unit/bookmark-router.test.js
    code_annotations:
      - IMPL-BOOKMARK_ROUTER
  related_decisions:
    depends_on:
      - IMPL-STORAGE_INDEX
      - ARCH-STORAGE_INDEX_AND_ROUTER
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-FILE_BOOKMARK_SERVICE
    composed_with:
      - IMPL-STORAGE_INDEX
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-FILE_BOOKMARK_SERVICE
      - IMPL-MOVE_BOOKMARK_UI
  detail_file: implementation-decisions/IMPL-BOOKMARK_ROUTER.yaml
  metadata:
    created:
      date: '2026-02-14'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Add IMPL-MOVE_BOOKMARK_UI to composed_with
IMPL-SYNC_BOOKMARK_SERVICE:
  name: Sync Bookmark Service
  status: Active
  cross_references:
    - ARCH-SYNC_STORAGE_PROVIDER
    - REQ-PER_BOOKMARK_STORAGE_BACKEND
  rationale:
    why: Fourth storage backend using chrome.storage.sync; same provider contract as LocalBookmarkService
    benefits:
      - Sync across Chrome profile devices; quota ~100 KB documented
  implementation_approach:
    summary: SyncBookmarkService in src/features/storage/sync-bookmark-service.js; chrome.storage.sync key hoverboard_sync_bookmarks.
  code_locations:
    files:
      - path: src/features/storage/sync-bookmark-service.js
        description: SyncBookmarkService implementation
  detail_file: implementation-decisions/IMPL-SYNC_BOOKMARK_SERVICE.yaml
  metadata:
    created:
      date: "2026-02-15"
      author: AI Agent
    last_updated:
      date: "2026-02-15"
      author: AI Agent
      reason: Extracted from index to detail file
IMPL-MOVE_BOOKMARK_UI:
  name: Move Bookmark Storage UI
  status: Active
  cross_references:
    - REQ-MOVE_BOOKMARK_STORAGE_UI
    - REQ-STORAGE_MODE_DEFAULT
    - ARCH-MOVE_BOOKMARK_UI
    - IMPL-BOOKMARK_ROUTER
  rationale:
    why: Popup control to show and change current bookmark storage backend; save must use highlighted backend
    problems_solved:
      - User cannot move bookmark between backends
      - Save not following highlighted storage on create/update from popup
    benefits:
      - Storage select-one buttons (Pinboard, File, Local, Sync) in popup; current highlighted; click sends moveBookmarkToStorage
      - Save follows highlight: getSelectedStorageBackend() and data.preferredBackend on createBookmark, addTagsToBookmark, toggle private/read-later (REQ-STORAGE_MODE_DEFAULT, REQ-MOVE_BOOKMARK_STORAGE_UI)
  implementation_approach:
    summary: 'Popup: storage section with four select-one buttons (Pinboard, File, Local, Sync); load backend on data load; on click send moveBookmarkToStorage; on save send preferredBackend so router uses highlighted storage.'
    details:
      - 'PopupController: on load get storage backend for current URL (or default when no bookmark); set highlighted button'
      - 'On select change: send moveBookmarkToStorage(url, targetBackend); refresh bookmark data'
      - 'On save (createBookmark, addTagsToBookmark, handleTogglePrivate, handleReadLater): add data.preferredBackend = getSelectedStorageBackend() so save follows highlight'
      - Pinboard storage option is disabled in the popup when no API token is configured (updateStoragePinboardEnabled from getAuthToken)
  code_locations:
    files:
      - path: src/ui/popup/popup.html
        description: Storage select markup
      - path: src/ui/popup/UIManager.js
        description: updateStoragePinboardEnabled(hasApiKey)
      - path: src/ui/popup/PopupController.js
        description: Load backend, handle move
  traceability:
    architecture:
      - ARCH-MOVE_BOOKMARK_UI
    requirements:
      - REQ-MOVE_BOOKMARK_STORAGE_UI
      - REQ-STORAGE_MODE_DEFAULT
    code_annotations:
      - IMPL-MOVE_BOOKMARK_UI
  related_decisions:
    depends_on:
      - ARCH-MOVE_BOOKMARK_UI
    supersedes: []
    see_also:
      - IMPL-BOOKMARK_ROUTER
    composed_with:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-STORAGE_INDEX
      - IMPL-MOVE_BOOKMARK_RESPONSE_AND_URL
  essence_pseudocode: |
    INPUT: currentUrl, currentPin, user action (select storage, save, toggle)
    ON load: backend = getStorageBackendForUrl or default; set highlighted button; show/hide file↔browser toggle.
    ON storage click: url = currentPin?.url || currentTab?.url; SEND moveBookmarkToStorage(url, target); result = response?.data ?? response; refresh on success.
    ON save: data.preferredBackend = getSelectedStorageBackend(); SEND saveBookmark(data).
  detail_file: implementation-decisions/IMPL-MOVE_BOOKMARK_UI.yaml
  metadata:
    created:
      date: '2026-02-14'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-MOVE_BOOKMARK_RESPONSE_AND_URL:
  name: Move Bookmark Response Handling and URL
  status: Active
  cross_references:
    - REQ-MOVE_BOOKMARK_STORAGE_UI
    - IMPL-MOVE_BOOKMARK_UI
    - IMPL-BOOKMARK_ROUTER
  rationale:
    why: UI must reflect actual move result; move must use bookmark URL and allow bookmark without time
    problems_solved:
      - Popup showed success when move failed (service worker wraps response)
      - Move failed when tab URL differed from stored bookmark URL
      - Move failed when source bookmark had no time field
  implementation_approach:
    summary: Popup uses inner result (response.data); move URL from currentPin when available; router accepts bookmark.url and sets time when missing.
  code_locations:
    files:
      - path: src/ui/popup/PopupController.js
        description: 'handleStorageBackendChange: url from currentPin, result from response.data'
      - path: src/features/storage/bookmark-router.js
        description: 'moveBookmarkToStorage: check bookmark.url, toSave with time if missing'
  traceability:
    requirements:
      - REQ-MOVE_BOOKMARK_STORAGE_UI
    code_annotations:
      - IMPL-MOVE_BOOKMARK_RESPONSE_AND_URL
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-MOVE_BOOKMARK_UI
      - IMPL-BOOKMARK_ROUTER
    composed_with:
      - IMPL-MOVE_BOOKMARK_UI
      - IMPL-BOOKMARK_ROUTER
  essence_pseudocode: |
    Popup: result = response?.data ?? response; show success/error from result. Move URL = currentPin?.url || currentTab?.url.
    Router: if bookmark has url but no time, toSave = { ...bookmark, time: now }; save to target, delete from source, update index.
  detail_file: implementation-decisions/IMPL-MOVE_BOOKMARK_RESPONSE_AND_URL.yaml
  metadata:
    created:
      date: '2026-02-14'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-NATIVE_HOST_WRAPPER:
  name: Native Host Wrapper Implementation
  status: Active
  cross_references:
    - ARCH-NATIVE_HOST
    - REQ-NATIVE_HOST_WRAPPER
  rationale:
    why: Thin host speaks Chrome protocol and delegates to helper in same dir
    problems_solved:
      - Host cannot use extension path
    benefits:
      - Go binary; ping/pong; helper.sh or helper.ps1 in same dir
  implementation_approach:
    summary: 'native_host/main.go: readMessage/writeMessage, install dir from os.Executable(), callHelper for helper.sh/helper.ps1/helper.exe'
    details:
      - 'Protocol: 4-byte native byte order length + JSON'
      - 'Helper: stdin = message JSON, stdout = response JSON'
  code_locations:
    files:
      - path: native_host/main.go
      - path: native_host/helper.sh
      - path: native_host/helper.ps1
  traceability:
    architecture:
      - ARCH-NATIVE_HOST
    requirements:
      - REQ-NATIVE_HOST_WRAPPER
    code_annotations:
      - IMPL-NATIVE_HOST_WRAPPER
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-NATIVE_HOST_INSTALLER
  detail_file: implementation-decisions/IMPL-NATIVE_HOST_WRAPPER.yaml
  metadata:
    created:
      date: '2026-02-14'
      author: AI Agent
    last_updated:
      date: '2026-02-14'
      author: AI Agent
      reason: Native host wrapper per plan
IMPL-NATIVE_HOST_INSTALLER:
  name: Native Host Installer Implementation
  status: Active
  cross_references:
    - ARCH-NATIVE_HOST
    - REQ-NATIVE_HOST_WRAPPER
  rationale:
    why: Copy wrapper and helper to fixed path and register with Chrome
    problems_solved:
      - Chrome needs manifest path and (Windows) registry
    benefits:
      - install.sh (macOS/Linux), install.ps1 (Windows); user-level install dir
  implementation_approach:
    summary: 'install.sh and install.ps1 copy binaries, generate manifest with path and allowed_origins, write to NativeMessagingHosts dir; Windows: registry key'
    details:
      - 'Install dir: ~/.hoverboard or %LOCALAPPDATA%\Hoverboard'
      - 'Manifest: com.hoverboard.native_host.json.template with {{PATH}} and {{ALLOWED_ORIGINS}}'
  code_locations:
    files:
      - path: native_host/install.sh
      - path: native_host/install.ps1
      - path: native_host/com.hoverboard.native_host.json.template
  traceability:
    architecture:
      - ARCH-NATIVE_HOST
    requirements:
      - REQ-NATIVE_HOST_WRAPPER
    code_annotations:
      - IMPL-NATIVE_HOST_INSTALLER
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-NATIVE_HOST_WRAPPER
  detail_file: implementation-decisions/IMPL-NATIVE_HOST_INSTALLER.yaml
  metadata:
    created:
      date: '2026-02-14'
      author: AI Agent
    last_updated:
      date: '2026-02-14'
      author: AI Agent
      reason: Native host installer per plan
IMPL-FILE_STORAGE_TYPED_PATH:
  name: File Storage User-Typed Path
  status: Active
  cross_references:
    - REQ-FILE_BOOKMARK_STORAGE
    - ARCH-FILE_BOOKMARK_PROVIDER
    - IMPL-NATIVE_HOST_WRAPPER
  rationale:
    why: Allow file storage without folder picker; user types path; native host performs read/write so no browser file permissions for directory listing
    problems_solved:
      - Folder picker unreliable on options page; path-based flow avoids picker
      - Single default path (~/.hoverboard) works out of the box
    benefits:
      - 'Options: path input (default ~/.hoverboard); native host reads/writes hoverboard-bookmarks.json; no offscreen doc for path flow'
      - Service worker uses NativeHostFileBookmarkAdapter when path set; picker flow (MessageFileBookmarkAdapter) when no path
  implementation_approach:
    summary: Options path input saved to hoverboard_file_storage_path; helper.sh/helper.ps1 handle readBookmarksFile/writeBookmarksFile with path (expand ~); NativeHostFileBookmarkAdapter; initBookmarkProvider prefers path over picker
    details:
      - 'Options: file-storage-path input, default ~/.hoverboard; persist on save and blur'
      - 'Helper: path as directory -> path/hoverboard-bookmarks.json; path ending .json as file; create dir on write; see IMPL-FILE_STORAGE_HELPER_PATH_NORMALIZE for HOME normalization and post-write check'
      - 'NativeHostFileBookmarkAdapter: get path from storage, sendNativeMessage with type and path'
      - 'Service worker: path set -> NativeHostFileBookmarkAdapter; else picker configured -> MessageFileBookmarkAdapter'
  code_locations:
    files:
      - path: src/ui/options/options.html
        description: Path input for file storage
      - path: src/ui/options/options.js
        description: Load/save path, persistFileStoragePath
      - path: native_host/helper.sh
        description: readBookmarksFile/writeBookmarksFile with path (Unix)
      - path: native_host/helper.ps1
        description: readBookmarksFile/writeBookmarksFile with path (Windows)
      - path: src/features/storage/native-host-file-bookmark-adapter.js
        description: Adapter using native host and path from storage
      - path: src/core/service-worker.js
        description: initBookmarkProvider path vs picker branch
  traceability:
    architecture:
      - ARCH-FILE_BOOKMARK_PROVIDER
    requirements:
      - REQ-FILE_BOOKMARK_STORAGE
    code_annotations:
      - IMPL-FILE_STORAGE_TYPED_PATH
  related_decisions:
    depends_on:
      - IMPL-NATIVE_HOST_WRAPPER
      - IMPL-FILE_BOOKMARK_SERVICE
    supersedes: []
    see_also:
      - IMPL-FILE_BOOKMARK_SERVICE
      - IMPL-FILE_STORAGE_HELPER_PATH_NORMALIZE
  detail_file: implementation-decisions/IMPL-FILE_STORAGE_TYPED_PATH.yaml
  metadata:
    created:
      date: "2026-02-14"
      author: AI Agent
    last_updated:
      date: "2026-02-14"
      author: AI Agent
      reason: Path-based file storage per plan
IMPL-FILE_STORAGE_HELPER_PATH_NORMALIZE:
  name: File Storage Helper Path Normalization
  status: Active
  cross_references:
    - IMPL-FILE_STORAGE_TYPED_PATH
    - REQ-FILE_BOOKMARK_STORAGE
  rationale:
    why: Chrome native host can set HOME with a trailing slash; concatenation produced paths like /Users/name//.hoverboard so the write could fail or create wrong path; return success only when file exists and is non-empty
    problems_solved:
      - Bookmark file not created when extension reported success (HOME trailing slash)
      - False success when write actually failed
    benefits:
      - expand_tilde uses ${HOME%/} so resolved path has no double slash
      - Helper returns error if file is missing or empty after write
  implementation_approach:
    summary: In helper.sh expand_tilde use H=${HOME%/}; after write, verify file exists and -s (non-empty) before echoing success
    details:
      - 'expand_tilde: H="${HOME%/}"; use H in all branches so ~/.hoverboard becomes /home/user/.hoverboard not /home/user//.hoverboard'
      - 'writeBookmarksFile: after echo DATA > FILE, if [ ! -f "$FILE" ] || [ ! -s "$FILE" ]; then echo error and exit'
  code_locations:
    files:
      - path: native_host/helper.sh
        description: expand_tilde and writeBookmarksFile post-write check
  traceability:
    architecture:
      - ARCH-FILE_BOOKMARK_PROVIDER
    requirements:
      - REQ-FILE_BOOKMARK_STORAGE
    tests:
      - tests/unit/helper-path-normalize.test.js
    code_annotations:
      - IMPL-FILE_STORAGE_HELPER_PATH_NORMALIZE
  related_decisions:
    depends_on:
      - IMPL-FILE_STORAGE_TYPED_PATH
    supersedes: []
    see_also:
      - IMPL-NATIVE_HOST_WRAPPER
  detail_file: implementation-decisions/IMPL-FILE_STORAGE_HELPER_PATH_NORMALIZE.yaml
  metadata:
    created:
      date: "2026-02-14"
      author: AI Agent
    last_updated:
      date: "2026-02-14"
      author: AI Agent
      reason: Helper path normalization and post-write verification
IMPL-CONFIG_BACKUP_RESTORE:
  name: Config Backup and Restore
  status: Active
  cross_references:
    - REQ-CONFIG_PORTABILITY
    - ARCH-CONFIG_STRUCTURE
  rationale:
    why: exportConfig/importConfig for backup and portability
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: ConfigManager.exportConfig(), importConfig()
    details: []
  code_locations:
    files:
      - path: src/config/config-manager.js
        description: exportConfig, importConfig
  traceability:
    architecture:
      - ARCH-CONFIG_STRUCTURE
    requirements:
      - REQ-CONFIG_PORTABILITY
    code_annotations:
      - IMPL-CONFIG_BACKUP_RESTORE
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-CONFIG_MIGRATION
  detail_file: implementation-decisions/IMPL-CONFIG_BACKUP_RESTORE.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Numbered token reinterpretation (CFG-001)
IMPL-CONFIG_MIGRATION:
  name: Config Migration and Auth
  status: Active
  cross_references:
    - REQ-CONFIG_PORTABILITY
    - ARCH-CONFIG_STRUCTURE
  rationale:
    why: Auth token storage, validation, API retry config
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: getAuthToken, setAuthToken, hasAuth, getAuthParam; retry in default config
    details: []
  code_locations:
    files:
      - path: src/config/config-manager.js
      - path: src/ui/options/options.js
  traceability:
    architecture:
      - ARCH-CONFIG_STRUCTURE
    requirements:
      - REQ-CONFIG_PORTABILITY
    code_annotations:
      - IMPL-CONFIG_MIGRATION
  related_decisions:
    depends_on: []
    supersedes: []
  detail_file: implementation-decisions/IMPL-CONFIG_MIGRATION.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Numbered token reinterpretation (CFG-002)
IMPL-FEATURE_FLAGS:
  name: Feature Flags and Settings
  status: Active
  cross_references:
    - REQ-CONFIG_PORTABILITY
    - ARCH-CONFIG_STRUCTURE
  rationale:
    why: Default config, getConfigForUI, updateConfig, getSettings, setSettings, resetToDefaults
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: Feature flags, UI behavior, badge config; ensureDefaults; getSettings/setSettings
    details: []
  code_locations:
    files:
      - path: src/config/config-manager.js
  traceability:
    architecture:
      - ARCH-CONFIG_STRUCTURE
    requirements:
      - REQ-CONFIG_PORTABILITY
    code_annotations:
      - IMPL-FEATURE_FLAGS
  related_decisions:
    depends_on: []
    supersedes: []
  detail_file: implementation-decisions/IMPL-FEATURE_FLAGS.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Numbered token reinterpretation (CFG-003)
IMPL-URL_INHIBITION:
  name: URL Inhibition
  status: Active
  cross_references:
    - REQ-SITE_MANAGEMENT
    - ARCH-CONFIG_STRUCTURE
  rationale:
    why: getInhibitUrls, addInhibitUrl, setInhibitUrls, isUrlInhibited
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: Inhibition list in storage; substring matching for isUrlInhibited
    details: []
  code_locations:
    files:
      - path: src/config/config-manager.js
  traceability:
    architecture:
      - ARCH-CONFIG_STRUCTURE
    requirements:
      - REQ-SITE_MANAGEMENT
    code_annotations:
      - IMPL-URL_INHIBITION
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-CONFIG_BACKUP_RESTORE
    composed_with:
      - IMPL-CONFIG_BACKUP_RESTORE
  essence_pseudocode: |
    getInhibitUrls(); addInhibitUrl(entry); setInhibitUrls(list); isUrlInhibited(url) — substring match against list.
  detail_file: implementation-decisions/IMPL-URL_INHIBITION.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-URL_UTILITIES:
  name: URL Utilities
  status: Active
  cross_references:
    - REQ-SHARED_UTILITIES
    - ARCH-SHARED_UTILITIES
  rationale:
    why: processUrl, isValidUrl, getDomain
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: urlUtils in src/shared/utils.js
    details: []
  code_locations:
    files:
      - path: src/shared/utils.js
  traceability:
    architecture:
      - ARCH-SHARED_UTILITIES
    requirements:
      - REQ-SHARED_UTILITIES
    code_annotations:
      - IMPL-URL_UTILITIES
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-TEXT_UTILITIES
      - IMPL-DOM_UTILITIES
    composed_with:
      - IMPL-ARRAY_OBJECT_UTILITIES
      - IMPL-TEXT_UTILITIES
  essence_pseudocode: |
    processUrl(url); isValidUrl(url); getDomain(url). Pure functions in utils.js.
  detail_file: implementation-decisions/IMPL-URL_UTILITIES.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-TEXT_UTILITIES:
  name: Text Utilities
  status: Active
  cross_references:
    - REQ-SHARED_UTILITIES
    - ARCH-SHARED_UTILITIES
  rationale:
    why: truncate, normalizeText, escapeHtml
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: stringUtils in src/shared/utils.js
    details: []
  code_locations:
    files:
      - path: src/shared/utils.js
  traceability:
    architecture:
      - ARCH-SHARED_UTILITIES
    requirements:
      - REQ-SHARED_UTILITIES
    code_annotations:
      - IMPL-TEXT_UTILITIES
  related_decisions:
    depends_on: []
    supersedes: []
  detail_file: implementation-decisions/IMPL-TEXT_UTILITIES.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Numbered token reinterpretation (UTIL-002)
IMPL-ARRAY_OBJECT_UTILITIES:
  name: Array and Object Utilities
  status: Active
  cross_references:
    - REQ-SHARED_UTILITIES
    - ARCH-SHARED_UTILITIES
  rationale:
    why: unique, chunk, compact; deepClone, isEmpty, pick
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: arrayUtils, objectUtils in src/shared/utils.js
    details: []
  code_locations:
    files:
      - path: src/shared/utils.js
  traceability:
    architecture:
      - ARCH-SHARED_UTILITIES
    requirements:
      - REQ-SHARED_UTILITIES
    code_annotations:
      - IMPL-ARRAY_OBJECT_UTILITIES
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-URL_UTILITIES
    composed_with:
      - IMPL-URL_UTILITIES
  essence_pseudocode: |
    unique(arr), chunk(arr, size), compact(arr); deepClone(obj), isEmpty(obj), pick(obj, keys). Pure functions; no mutation.
  detail_file: implementation-decisions/IMPL-ARRAY_OBJECT_UTILITIES.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-TIME_ASYNC_UTILITIES:
  name: Time and Async Utilities
  status: Active
  cross_references:
    - REQ-SHARED_UTILITIES
    - ARCH-SHARED_UTILITIES
  rationale:
    why: delay, formatTimestamp, getRelativeTime
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: timeUtils in src/shared/utils.js
    details: []
  code_locations:
    files:
      - path: src/shared/utils.js
  traceability:
    architecture:
      - ARCH-SHARED_UTILITIES
    requirements:
      - REQ-SHARED_UTILITIES
    code_annotations:
      - IMPL-TIME_ASYNC_UTILITIES
  related_decisions:
    depends_on: []
    supersedes: []
  detail_file: implementation-decisions/IMPL-TIME_ASYNC_UTILITIES.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Numbered token reinterpretation (UTIL-004)
IMPL-DOM_UTILITIES:
  name: DOM Utilities
  status: Active
  cross_references:
    - REQ-SHARED_UTILITIES
    - ARCH-SHARED_UTILITIES
  rationale:
    why: waitForElement, createElement; createPinFromFormData, validatePinFormData
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: domUtils and legacy helpers in src/shared/utils.js
    details: []
  code_locations:
    files:
      - path: src/shared/utils.js
  traceability:
    architecture:
      - ARCH-SHARED_UTILITIES
    requirements:
      - REQ-SHARED_UTILITIES
    code_annotations:
      - IMPL-DOM_UTILITIES
  related_decisions:
    depends_on: []
    supersedes: []
  detail_file: implementation-decisions/IMPL-DOM_UTILITIES.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-17"
      author: AI Agent
      reason: Numbered token reinterpretation (UTIL-005)
IMPL-LOGGER_CONTEXT_LEVELS:
  name: Logger Context and Levels
  status: Active
  cross_references:
    - REQ-STRUCTURED_LOGGING
    - ARCH-STRUCTURED_LOGGING
  rationale:
    why: Logger context, shouldLog, formatMessage, debug/info/warn/error; createLogger
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: Logger class, logger, createLogger in src/shared/logger.js
    details: []
  code_locations:
    files:
      - path: src/shared/logger.js
  traceability:
    architecture:
      - ARCH-STRUCTURED_LOGGING
    requirements:
      - REQ-STRUCTURED_LOGGING
    code_annotations:
      - IMPL-LOGGER_CONTEXT_LEVELS
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-LOG_LEVEL_CONFIG
      - IMPL-LOGGER_LEGACY
    composed_with:
      - IMPL-LOG_LEVEL_CONFIG
      - IMPL-LOGGER_LEGACY
  essence_pseudocode: |
    Logger(context); shouldLog(level); formatMessage; debug/info/warn/error. logger, createLogger.
  detail_file: implementation-decisions/IMPL-LOGGER_CONTEXT_LEVELS.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-LOG_LEVEL_CONFIG:
  name: Log Level Configuration
  status: Active
  cross_references:
    - REQ-STRUCTURED_LOGGING
    - ARCH-STRUCTURED_LOGGING
  rationale:
    why: getLogLevel from NODE_ENV; debug in dev, warn in production
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: getLogLevel() in src/shared/logger.js
    details: []
  code_locations:
    files:
      - path: src/shared/logger.js
  traceability:
    architecture:
      - ARCH-STRUCTURED_LOGGING
    requirements:
      - REQ-STRUCTURED_LOGGING
    code_annotations:
      - IMPL-LOG_LEVEL_CONFIG
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-LOGGER_CONTEXT_LEVELS
      - IMPL-LOGGER_LEGACY
    composed_with:
      - IMPL-LOGGER_CONTEXT_LEVELS
      - IMPL-LOGGER_LEGACY
  essence_pseudocode: |
    getLogLevel() from NODE_ENV; production => warn, else => debug. Used by shouldLog.
  detail_file: implementation-decisions/IMPL-LOG_LEVEL_CONFIG.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with
IMPL-LOGGER_LEGACY:
  name: Logger Legacy Compatibility
  status: Active
  cross_references:
    - REQ-STRUCTURED_LOGGING
    - ARCH-STRUCTURED_LOGGING
  rationale:
    why: log(context, ...args), noisy export
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: log(), noisy in src/shared/logger.js
    details: []
  code_locations:
    files:
      - path: src/shared/logger.js
  traceability:
    architecture:
      - ARCH-STRUCTURED_LOGGING
    requirements:
      - REQ-STRUCTURED_LOGGING
    code_annotations:
      - IMPL-LOGGER_LEGACY
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-LOGGER_CONTEXT_LEVELS
      - IMPL-LOG_LEVEL_CONFIG
    composed_with:
      - IMPL-LOGGER_CONTEXT_LEVELS
      - IMPL-LOG_LEVEL_CONFIG
  essence_pseudocode: |
    log(context, ...args) -> debug; noisy for migration. Same logger module.
  detail_file: implementation-decisions/IMPL-LOGGER_LEGACY.yaml
  metadata:
    created:
      date: "2026-02-17"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with

IMPL-SELECTION_TO_TAG_INPUT:
  name: Selection to tag input on icon click
  status: Active
  cross_references:
    - ARCH-SELECTION_TO_TAG_INPUT
    - REQ-SELECTION_TO_TAG_INPUT
  rationale:
    why: Prefill New Tag input from page selection when user opens popup so they can submit selection as tags
    problems_solved:
      - Manual copy-paste of selection into tag input
    benefits:
      - One-click flow: select text, click icon, submit as tags
  implementation_approach:
    summary: Content script GET_PAGE_SELECTION; popup loadInitialData requests selection, normalizes (strip punctuation, first 8 words), sets tag input via setTagInputValue
    details:
      - normalizeSelectionForTagInput in shared utils; UIManager.setTagInputValue
      - Chrome and Safari content-main and PopupController
  code_locations:
    files:
      - path: src/features/content/content-main.js
      - path: safari/src/features/content/content-main.js
      - path: src/ui/popup/PopupController.js
      - path: safari/src/ui/popup/PopupController.js
      - path: src/ui/popup/UIManager.js
      - path: safari/src/ui/popup/UIManager.js
      - path: src/shared/utils.js
      - path: safari/src/shared/utils.js
  traceability:
    architecture:
      - ARCH-SELECTION_TO_TAG_INPUT
    requirements:
      - REQ-SELECTION_TO_TAG_INPUT
    code_annotations:
      - IMPL-SELECTION_TO_TAG_INPUT
  related_decisions:
    depends_on: []
    supersedes: []
  detail_file: implementation-decisions/IMPL-SELECTION_TO_TAG_INPUT.yaml
  metadata:
    created:
      date: "2026-02-18"
      author: AI Agent
    last_updated:
      date: "2026-02-18"
      author: AI Agent
      reason: Selection-to-tag input feature
IMPL-BOOKMARK_CREATE_UPDATE_TIMES:
  name: Bookmark Create and Update Time Implementation
  status: Active
  cross_references:
    - ARCH-BOOKMARK_CREATE_UPDATE_TIMES
    - REQ-BOOKMARK_CREATE_UPDATE_TIMES
  rationale:
    why: Provider-specific rules for setting and normalizing time and updated_at.
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: 'LocalBookmarkService, FileBookmarkService, SyncBookmarkService: createEmptyBookmark and _normalizeBookmark include updated_at; saveBookmark sets time and updated_at on create (both now), preserves time and sets updated_at on update. PinboardService: parseBookmarkResponse and createEmptyBookmark set updated_at = time; do not send updated_at to API. url-tags-manager normalizeBookmarkForDisplay, bookmark-router moveBookmarkToStorage, PopupController empty pin, export/import CSV and JSON include updated_at; legacy read normalizes updated_at = time.'
    details: []
  code_locations:
    files:
      - path: src/features/storage/local-bookmark-service.js
      - path: src/features/storage/file-bookmark-service.js
      - path: src/features/storage/sync-bookmark-service.js
      - path: src/features/pinboard/pinboard-service.js
      - path: safari/src/features/pinboard/pinboard-service.js
      - path: src/features/storage/url-tags-manager.js
      - path: src/features/storage/bookmark-router.js
      - path: src/ui/popup/PopupController.js
      - path: src/ui/bookmarks-table/bookmarks-table-csv.js
      - path: src/ui/bookmarks-table/bookmarks-table.js
  traceability:
    architecture:
      - ARCH-BOOKMARK_CREATE_UPDATE_TIMES
    requirements:
      - REQ-BOOKMARK_CREATE_UPDATE_TIMES
    tests:
      - tests/unit/file-bookmark-service.test.js
      - tests/unit/sync-bookmark-service.test.js
      - tests/unit/local-bookmark-service.test.js
      - tests/unit/url-tags-manager.test.js
      - tests/unit/bookmarks-table-export.test.js
      - tests/unit/bookmarks-table-import.test.js
      - tests/unit/pinboard-bookmark-times.test.js
      - tests/unit/bookmark-router.test.js
    code_annotations:
      - IMPL-BOOKMARK_CREATE_UPDATE_TIMES
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-FILE_BOOKMARK_SERVICE
      - IMPL-URL_TAGS_DISPLAY
    composed_with:
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-FILE_BOOKMARK_SERVICE
      - IMPL-BOOKMARK_ROUTER
      - IMPL-LOCAL_BOOKMARKS_INDEX_EXPORT
      - IMPL-LOCAL_BOOKMARKS_INDEX_IMPORT
  essence_pseudocode: |
    Local/File/Sync: create -> time=now, updated_at=now; update -> keep time, updated_at=now. Pinboard: updated_at=time; never send to API. Normalize/legacy: updated_at=time if missing.
  detail_file: implementation-decisions/IMPL-BOOKMARK_CREATE_UPDATE_TIMES.yaml
  metadata:
    created:
      date: '2026-02-18'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical detail rewrite; add essence_pseudocode and composed_with

IMPL-SCREENSHOT_MODE:
  name: Screenshot/Demo mode for placeholder screenshots
  status: Active
  cross_references:
    - IMPL-LOCAL_BOOKMARK_SERVICE
    - IMPL-UI_TESTABILITY_HOOKS
    - REQ-LOCAL_BOOKMARKS_INDEX
  rationale:
    why: Enable automated generation of README/docs screenshots with placeholder bookmark data
    problems_solved:
      - Popup opened as a tab in Playwright has that tab as "active", so bookmark data would be for the wrong URL
      - Storage seed was not awaited, so popup could load before data was written
      - No store checkbox checked on index page, so seeded bookmarks were filtered out (REQ-LOCAL_BOOKMARKS_INDEX: Stores default unchecked)
      - Manual screenshot capture is brittle and uses live user data
    benefits:
      - Repeatable screenshot script; no live bookmarks; deterministic placeholder data; optional seed from file
  implementation_approach:
    summary: Popup reads ?screenshot=1&url=...&title=... and uses them as fake current tab; script awaits storage seed, waits for data-screenshot-ready; message handler prefers data.url when http(s); script can load seed from file; script checks Local store before index screenshot
    details:
      - PopupController.loadInitialData checks URL params; when screenshot=1 and url present, skip getCurrentTab() and use decoded url/title; in finally, set data-screenshot-ready on #mainInterface so script can wait for content
      - MessageHandler.handleGetCurrentBookmark: when data.url is present and is http(s), use it as targetUrl so popup-opened-as-tab gets bookmark for the screenshot URL, not the extension tab URL
      - scripts/screenshot-placeholder-data.js exports placeholderStorageSeed (local bookmarks + storage index, hoverboard_theme) and placeholderSyncSeed (showHoverOnPageLoad)
      - scripts/screenshots-placeholder.js: await chrome.storage.local.set/sync.set in options page; optional --seed=path or SCREENSHOT_SEED_FILE for seed JSON (hoverboard_local_bookmarks, hoverboard_storage_index, hoverboard_theme?, hoverboard_settings?); wait for [data-screenshot-ready="true"] before popup screenshot; check #store-local before bookmarks index screenshot so seeded local bookmarks are visible
      - scripts/screenshot-seed.example.json: example seed file matching the expected JSON shape
      - Popup must honor hoverboard_theme so screenshot shows dark popup when seed includes hoverboard_theme: 'dark' (see IMPL-POPUP_THEME_CSS)
  code_locations:
    files:
      - path: src/ui/popup/PopupController.js
        description: Screenshot mode param check, _screenshotMode, data-screenshot-ready in finally
      - path: src/core/message-handler.js
        description: handleGetCurrentBookmark prefers data.url when http(s)
      - path: scripts/screenshot-placeholder-data.js
        description: Placeholder bookmark and sync seed data
      - path: scripts/screenshots-placeholder.js
        description: Playwright script; await seed; seed-from-file; wait for data-screenshot-ready; check store-local
      - path: scripts/screenshot-seed.example.json
        description: Example seed file for --seed / SCREENSHOT_SEED_FILE
  traceability:
    code_annotations:
      - IMPL-SCREENSHOT_MODE
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-POPUP_THEME_CSS
      - REQ-LOCAL_BOOKMARKS_INDEX
  detail_file: implementation-decisions/IMPL-SCREENSHOT_MODE.yaml
  metadata:
    created:
      date: "2026-02-19"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Screenshot fixes and formal seed-from-file; data-screenshot-ready; store checkbox for index

IMPL-POPUP_THEME_CSS:
  name: Popup CSS honors ThemeManager (hb-theme-dark)
  status: Active
  cross_references:
    - REQ-DARK_THEME
    - ARCH-THEME
    - IMPL-SCREENSHOT_MODE
  rationale:
    why: Popup must reflect ThemeManager-applied theme so dark preference and screenshot seed (hoverboard_theme: 'dark') show dark popup
    problems_solved:
      - Popup stayed light when hoverboard_theme was 'dark' because popup.css only overrode variables in @media (prefers-color-scheme: dark), not when document root had class hb-theme-dark
    benefits:
      - Dark theme preference applies to popup; placeholder screenshots show dark popup when seed includes hoverboard_theme: 'dark'
  implementation_approach:
    summary: Add :root.hb-theme-dark block in popup.css with same dark variable values as the prefers-color-scheme media query
    details:
      - ThemeManager applies hb-theme-dark to document.documentElement and sets --hb-* variables; popup uses --bg-primary, --text-primary, etc. from popup.css
      - popup.css had no rule for :root.hb-theme-dark, so body stayed white; add :root.hb-theme-dark { --bg-primary: #1e1e1e; ... } so popup uses dark variables when ThemeManager sets dark
  code_locations:
    files:
      - path: src/ui/popup/popup.css
        description: ':root.hb-theme-dark block for popup dark theme'
  traceability:
    requirements:
      - REQ-DARK_THEME
    architecture:
      - ARCH-THEME
    code_annotations:
      - IMPL-POPUP_THEME_CSS
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-SCREENSHOT_MODE
  detail_file: implementation-decisions/IMPL-POPUP_THEME_CSS.yaml
  metadata:
    created:
      date: "2026-02-19"
      author: AI Agent
    last_updated:
      date: "2026-02-19"
      author: AI Agent
      reason: Popup dark mode fix for screenshot and theme preference

IMPL-TAB_SEARCH_SERVICE:
  name: Tab Search Service Implementation
  status: Active
  cross_references:
    - REQ-SEARCH_FUNCTIONALITY
  rationale:
    why: Implements in-extension tab search by title with navigate-to-match and circular navigation.
    problems_solved:
      - Finding and switching to browser tabs by title from the extension
      - Repeating search cycles through multiple matches (circular navigation)
    benefits:
      - Fast tab discovery and focus from popup/overlay
      - Search history and continuation from last position
  implementation_approach:
    summary: TabSearchService queries chrome.tabs, filters by title substring, selects next match (with wrap-around), activates tab and focuses window; maintains lastSearchText and lastMatchedTabId for continuation.
    details:
      - searchAndNavigate(searchText, currentTabId): normalize search, get all tabs, filter by title, find next after current/last match (circular), activate tab and focus window; return { success, matchCount, tabId, tabTitle } or { success: false, message }
      - findNextTab(matchingTabs, restartTabId): circular navigation; addToSearchHistory
      - Chrome API errors surfaced as rejected promise
  code_locations:
    files:
      - path: src/features/search/tab-search-service.js
        description: TabSearchService class
    functions:
      - name: searchAndNavigate
        file: src/features/search/tab-search-service.js
        description: Search tabs by title and navigate to next match
      - name: findNextTab
        file: src/features/search/tab-search-service.js
        description: Select next tab in match list with circular wrap
      - name: addToSearchHistory
        file: src/features/search/tab-search-service.js
        description: Maintain search history (move to front if duplicate)
  traceability:
    architecture: []
    requirements:
      - REQ-SEARCH_FUNCTIONALITY
    tests:
      - tests/unit/tab-search-service.test.js
    code_annotations:
      - IMPL-TAB_SEARCH_SERVICE
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
    composed_with: []
  detail_file: implementation-decisions/IMPL-TAB_SEARCH_SERVICE.yaml
  metadata:
    created:
      date: "2026-02-20"
      author: AI Agent
    last_updated:
      date: "2026-02-20"
      author: AI Agent
      reason: Create IMPL for tab-search-service tests; add to index
IMPL-AI_CONFIG_OPTIONS:
  name: AI Config in Options
  status: Active
  cross_references:
    - ARCH-AI_TAGGING_CONFIG
    - REQ-AI_TAGGING_CONFIG
  rationale:
    why: Options page must expose and persist AI API key, provider, and optional limit
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: ConfigManager defaultConfig and storage include aiApiKey, aiProvider, aiTagLimit; options.html section; options.js bind, load, save; Test button calls testAiApiKey.
  code_locations:
    files:
      - path: src/config/config-manager.js
      - path: src/ui/options/options.html
      - path: src/ui/options/options.js
    functions: []
  traceability:
    architecture:
      - ARCH-AI_TAGGING_CONFIG
    requirements:
      - REQ-AI_TAGGING_CONFIG
    tests:
      - tests/unit/config-manager.test.js
    code_annotations:
      - IMPL-AI_CONFIG_OPTIONS
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-CONFIG_MIGRATION
      - IMPL-AI_TAG_TEST
    composed_with:
      - IMPL-AI_TAG_TEST
  detail_file: implementation-decisions/IMPL-AI_CONFIG_OPTIONS.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Initial creation
IMPL-AI_TAG_TEST:
  name: AI API Key Test
  status: Active
  cross_references:
    - ARCH-AI_TAGGING_CONFIG
    - REQ-AI_TAGGING_CONFIG
  rationale:
    why: User should verify API key works before using AI tagging
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: testAiApiKey(apiKey, provider) performs minimal request (OpenAI/Gemini); returns { ok, error }. Options and popup each have Test API key button showing "API key OK" or error; unit-testable with fetch mock.
  code_locations:
    files:
      - path: src/features/ai/ai-api-test.js
      - path: src/ui/options/options.html
      - path: src/ui/options/options.js
      - path: src/ui/popup/popup.html
      - path: src/ui/popup/PopupController.js
      - path: src/ui/popup/UIManager.js
    functions:
      - name: testAiApiKey
        file: src/features/ai/ai-api-test.js
      - name: handleTestAiApiKey
        file: src/ui/popup/PopupController.js
  traceability:
    architecture:
      - ARCH-AI_TAGGING_CONFIG
    requirements:
      - REQ-AI_TAGGING_CONFIG
    tests:
      - tests/unit/ai-api-test.test.js
    code_annotations:
      - IMPL-AI_TAG_TEST
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-AI_CONFIG_OPTIONS
    composed_with: []
  detail_file: implementation-decisions/IMPL-AI_TAG_TEST.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Popup Test API key button; code_locations for options and popup
IMPL-AI_TAGGING_READABILITY:
  name: Page Content via Readability
  status: Active
  cross_references:
    - ARCH-AI_TAGGING_FLOW
    - REQ-AI_TAGGING_POPUP
  rationale:
    why: AI needs page content; SW path works without content script; Readability when script present
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: SW handleGetPageContent uses scripting.executeScript with inline func (title + body.innerText, 16k cap). Content script early listener for GET_PAGE_CONTENT runs extractPageContent (Readability) when present.
  code_locations:
    files:
      - path: src/core/message-handler.js
      - path: src/features/content/content-main.js
      - path: src/features/ai/readability-extract.js
    functions:
      - name: handleGetPageContent
        file: src/core/message-handler.js
      - name: extractPageContent
        file: src/features/ai/readability-extract.js
  traceability:
    architecture:
      - ARCH-AI_TAGGING_FLOW
    requirements:
      - REQ-AI_TAGGING_POPUP
    tests:
      - tests/unit/readability-extract.test.js
    code_annotations:
      - IMPL-AI_TAGGING_READABILITY
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-AI_TAGGING_PROVIDER
    composed_with: []
  detail_file: implementation-decisions/IMPL-AI_TAGGING_READABILITY.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-21'
      author: AI Agent
      reason: GET_PAGE_CONTENT in SW via executeScript; content script early listener for Readability
IMPL-AI_TAGGING_PROVIDER:
  name: OpenAI/Gemini Tag Request
  status: Active
  cross_references:
    - ARCH-AI_TAGGING_FLOW
    - REQ-AI_TAGGING_POPUP
    - REQ-TAG_INPUT_SANITIZATION
  rationale:
    why: Call provider API with page text and get back list of tags; sanitize with existing tag rules
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: requestAiTags(provider, apiKey, text, limit) calls OpenAI or Gemini, parses response to lines, sanitizeTag each, filter null, dedupe, slice(0, limit).
  code_locations:
    files:
      - path: src/features/ai/ai-tagging-provider.js
    functions:
      - name: requestAiTags
        file: src/features/ai/ai-tagging-provider.js
  traceability:
    architecture:
      - ARCH-AI_TAGGING_FLOW
    requirements:
      - REQ-AI_TAGGING_POPUP
      - REQ-TAG_INPUT_SANITIZATION
    tests:
      - tests/unit/ai-tagging-provider.test.js
    code_annotations:
      - IMPL-AI_TAGGING_PROVIDER
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-TAG_SYSTEM
      - IMPL-AI_TAGGING_READABILITY
    composed_with: []
  detail_file: implementation-decisions/IMPL-AI_TAGGING_PROVIDER.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Initial creation
IMPL-SESSION_TAGS:
  name: Session Tags for Auto-Apply
  status: Active
  cross_references:
    - ARCH-AI_TAGGING_FLOW
    - REQ-AI_TAGGING_POPUP
  rationale:
    why: Tags added to any site this session should auto-apply to current bookmark when AI returns them
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: getSessionTags() and recordSessionTags(tags); chrome.storage.session or in-memory in SW; add on saveTag/saveBookmark success.
  code_locations:
    files:
      - path: src/features/ai/session-tags.js
      - path: src/core/message-handler.js
    functions:
      - name: getSessionTags
        file: src/features/ai/session-tags.js
      - name: recordSessionTags
        file: src/features/ai/session-tags.js
  traceability:
    architecture:
      - ARCH-AI_TAGGING_FLOW
    requirements:
      - REQ-AI_TAGGING_POPUP
    tests:
      - tests/unit/session-tags.test.js
    code_annotations:
      - IMPL-SESSION_TAGS
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-AI_TAGGING_POPUP_UI
    composed_with: []
  detail_file: implementation-decisions/IMPL-SESSION_TAGS.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Initial creation
IMPL-AI_TAGGING_POPUP_UI:
  name: AI Tagging Popup Button and Flow
  status: Active
  cross_references:
    - ARCH-AI_TAGGING_FLOW
    - REQ-AI_TAGGING_POPUP
    - REQ-STORAGE_MODE_DEFAULT
  rationale:
    why: Single entry point in popup to run full AI tagging flow and update UI
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: Popup "Tag with AI" button; GET_PAGE_CONTENT sent to SW (SW uses scripting.executeScript in tab); GET_AI_TAGS, getSessionTags; popup shows content.error when extraction fails; split inSession vs suggested; save bookmark with preferredBackend = getStorageMode() when new; updateSuggestedTags(suggested).
  code_locations:
    files:
      - path: src/ui/popup/popup.html
      - path: src/ui/popup/PopupController.js
      - path: src/ui/popup/UIManager.js
      - path: src/core/message-handler.js
    functions:
      - name: handleTagWithAi
        file: src/ui/popup/PopupController.js
  traceability:
    architecture:
      - ARCH-AI_TAGGING_FLOW
    requirements:
      - REQ-AI_TAGGING_POPUP
      - REQ-STORAGE_MODE_DEFAULT
    tests:
      - tests/unit/ai-tagging-popup.test.js
    code_annotations:
      - IMPL-AI_TAGGING_POPUP_UI
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-SUGGESTED_TAGS
      - IMPL-SESSION_TAGS
    composed_with:
      - IMPL-AI_TAGGING_READABILITY
      - IMPL-AI_TAGGING_PROVIDER
      - IMPL-SESSION_TAGS
  detail_file: implementation-decisions/IMPL-AI_TAGGING_POPUP_UI.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-21'
      author: AI Agent
      reason: GET_PAGE_CONTENT via SW executeScript; popup shows content.error on failure
IMPL-SIDE_PANEL_TAGS_TREE:
  name: Side Panel Tags and Bookmarks Tree Implementation
  status: Active
  cross_references:
    - ARCH-SIDE_PANEL_TAGS_TREE
    - REQ-SIDE_PANEL_TAGS_TREE
  rationale:
    why: Implements ARCH-SIDE_PANEL_TAGS_TREE and REQ-SIDE_PANEL_TAGS_TREE with one IMPL covering open flow, data build, and panel UI.
    problems_solved:
      - No side panel entry or tag-tree view
    benefits:
      - Single traceable IMPL; pure buildTagToBookmarks testable in isolation; open flow and panel UI prescribed by pseudo-code
  implementation_approach:
    summary: Popup button and handler send OPEN_SIDE_PANEL; SW handles message and calls chrome.sidePanel.open({ windowId }). Panel page on load sends getAggregatedBookmarksForIndex; buildTagToBookmarks(bookmarks) returns tag to [{ title, url }]; derive allTags; tag selector (selected + order, optional persist); render tree (each selected tag to collapsible section); click URL to chrome.tabs.create({ url }).
    details:
      - ui-action-contract: add openTagsTree to POPUP_ACTION_IDS
      - Popup: footer button, UIManager element + emit, PopupController handler sends OPEN_SIDE_PANEL
      - Service worker: listener for OPEN_SIDE_PANEL; chrome.sidePanel.open({ windowId })
      - Panel: tags-tree.html, tags-tree.js, tags-tree.css; tags-tree-data.js (pure buildTagToBookmarks) for unit tests
  code_locations:
    files:
      - path: src/ui/side-panel/tags-tree-data.js
      - path: src/ui/side-panel/tags-tree.html
      - path: src/ui/side-panel/tags-tree.js
      - path: src/ui/side-panel/tags-tree.css
      - path: src/ui/popup/popup.html
      - path: src/ui/popup/UIManager.js
      - path: src/ui/popup/PopupController.js
      - path: src/core/service-worker.js
      - path: src/shared/ui-action-contract.js
    functions:
      - name: buildTagToBookmarks
        file: src/ui/side-panel/tags-tree-data.js
      - name: getAllTagsFromBookmarks
        file: src/ui/side-panel/tags-tree-data.js
      - name: handleOpenTagsTree
        file: src/ui/popup/PopupController.js
  traceability:
    architecture:
      - ARCH-SIDE_PANEL_TAGS_TREE
    requirements:
      - REQ-SIDE_PANEL_TAGS_TREE
    tests:
      - tests/unit/tags-tree-data.test.js
      - tests/unit/tags-tree-filter.test.js
      - tests/unit/side-panel-open.test.js
    code_annotations:
      - IMPL-SIDE_PANEL_TAGS_TREE
  related_decisions:
    depends_on:
      - ARCH-SIDE_PANEL_TAGS_TREE
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARKS_INDEX
    composed_with:
      - IMPL-MESSAGE_HANDLING
  detail_file: implementation-decisions/IMPL-SIDE_PANEL_TAGS_TREE.yaml
  metadata:
    created:
      date: '2026-02-21'
      author: AI Agent
    last_updated:
      date: '2026-02-21'
      author: AI Agent
      reason: Initial creation
IMPL-SIDE_PANEL_BOOKMARK_SEARCH:
  name: Side Panel Bookmark Search Implementation
  status: Active
  cross_references:
    - ARCH-SIDE_PANEL_BOOKMARK_SEARCH
    - REQ-SIDE_PANEL_BOOKMARK_SEARCH
  rationale:
    why: Implements ARCH-SIDE_PANEL_BOOKMARK_SEARCH and REQ-SIDE_PANEL_BOOKMARK_SEARCH with pure filter plus panel UI.
    problems_solved:
      - No search in side panel list
    benefits:
      - Testable filterBookmarksBySearch; search bar, count, Next/Previous with scroll and highlight
  implementation_approach:
    summary: filterBookmarksBySearch in tags-tree-filter.js; tags-tree.js/html/css: search input, count, Next/Previous; data-search-index on links; scroll and highlight current match.
  code_locations:
    files:
      - path: src/ui/side-panel/tags-tree-filter.js
      - path: src/ui/side-panel/tags-tree.js
      - path: src/ui/side-panel/tags-tree.html
      - path: src/ui/side-panel/tags-tree.css
    functions:
      - name: filterBookmarksBySearch
        file: src/ui/side-panel/tags-tree-filter.js
  traceability:
    architecture:
      - ARCH-SIDE_PANEL_BOOKMARK_SEARCH
    requirements:
      - REQ-SIDE_PANEL_BOOKMARK_SEARCH
    tests:
      - tests/unit/tags-tree-filter.test.js
    code_annotations:
      - IMPL-SIDE_PANEL_BOOKMARK_SEARCH
  related_decisions:
    depends_on:
      - ARCH-SIDE_PANEL_BOOKMARK_SEARCH
    supersedes: []
    see_also:
      - IMPL-SIDE_PANEL_TAGS_TREE
    composed_with:
      - IMPL-SIDE_PANEL_TAGS_TREE
  detail_file: implementation-decisions/IMPL-SIDE_PANEL_BOOKMARK_SEARCH.yaml
  metadata:
    created:
      date: '2026-02-22'
      author: AI Agent
    last_updated:
      date: '2026-02-22'
      author: AI Agent
      reason: Initial creation
