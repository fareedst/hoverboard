IMPL-NATIVE_HOST_WRAPPER:
  name: Native Host Wrapper Implementation
  status: Active
  cross_references:
    - ARCH-NATIVE_HOST
    - REQ-NATIVE_HOST_WRAPPER
  rationale:
    why: Thin native messaging host reads length-prefixed JSON from stdin; handles ping with pong; otherwise invokes helper script and returns helper JSON; debug to stderr.
    problems_solved: []
    benefits: []
  implementation_approach:
    summary: Go binary in native_host/; 4-byte length (native order) + UTF-8 JSON; max 64 MiB in, 1 MB out; ping/pong; helper in same dir (helper.sh or helper.ps1 on Windows).
    details: []
  code_locations:
    files:
      - path: native_host/main.go
        description: Protocol read/write, ping, helper invocation
      - path: native_host/helper.sh
        description: Unix helper
      - path: native_host/helper.ps1
        description: Windows helper
    functions: []
  traceability:
    architecture:
      - ARCH-NATIVE_HOST
    requirements:
      - REQ-NATIVE_HOST_WRAPPER
    tests:
      - native_host/main_test.go
      - tests/unit/native-host-ping.test.js
    code_annotations:
      - IMPL-NATIVE_HOST_WRAPPER
      - ARCH-NATIVE_HOST
      - REQ-NATIVE_HOST_WRAPPER
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-NATIVE_HOST_INSTALLER
    composed_with:
      - IMPL-NATIVE_HOST_INSTALLER
  essence_pseudocode: |
    INPUT: stdin — 4-byte length (native byte order) then UTF-8 JSON message (max 64 MiB from Chrome)
    OUTPUT: stdout — 4-byte length then UTF-8 JSON response (max 1 MB to Chrome); stderr for debug/TRACE
    DATA: install_dir = dir of executable; helper = helper.sh (Unix) or helper.exe then helper.ps1 (Windows)

    loop:
      READ 4-byte length L
      READ L bytes UTF-8 into message
      PARSE message as JSON

      IF message.type === "ping":
        WRITE length-prefixed JSON {"type":"pong"} to stdout
        CONTINUE

      RESOLVE helper path from install_dir (helper.sh or helper.ps1/helper.exe)
      IF no helper:
        ECHO request or pong to stdout (per product rule)
        CONTINUE

      INVOKE helper with message JSON on stdin
      READ helper stdout as single JSON object
      WRITE length-prefixed response to stdout
  detail_file: implementation-decisions/IMPL-NATIVE_HOST_WRAPPER.yaml
  metadata:
    created:
      date: '2026-02-18'
      author: MCP converter
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical YAML rewrite; add essence_pseudocode and composed_with; remove extraneous keys
    last_validated:
      date: '2026-02-18'
      validator: MCP converter
      result: pass
