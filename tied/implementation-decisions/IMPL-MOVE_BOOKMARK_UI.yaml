IMPL-MOVE_BOOKMARK_UI:
  name: Move Bookmark Storage UI
  status: Active
  cross_references:
    - REQ-MOVE_BOOKMARK_STORAGE_UI
    - REQ-STORAGE_MODE_DEFAULT
    - ARCH-MOVE_BOOKMARK_UI
    - IMPL-BOOKMARK_ROUTER
  rationale:
    why: Popup control to show and change current bookmark storage backend; save must use highlighted backend.
    problems_solved:
      - User cannot move bookmark between backends
      - Save not following highlighted storage on create/update from popup
    benefits:
      - Storage select-one buttons (Pinboard, File, Local, Sync) in popup; current highlighted; click sends moveBookmarkToStorage
      - Save follows highlight: getSelectedStorageBackend() and data.preferredBackend on createBookmark, addTagsToBookmark, toggle private/read-later (REQ-STORAGE_MODE_DEFAULT, REQ-MOVE_BOOKMARK_STORAGE_UI)
  implementation_approach:
    summary: 'Popup: storage section with four select-one buttons (Pinboard, File, Local, Sync); load backend on data load; on click send moveBookmarkToStorage; on save send preferredBackend so router uses highlighted storage.'
    details:
      - 'PopupController: on load get storage backend for current URL (or default when no bookmark); set highlighted button'
      - 'On select change: send moveBookmarkToStorage(url, targetBackend); refresh bookmark data'
      - 'On save (createBookmark, addTagsToBookmark, handleTogglePrivate, handleReadLater): add data.preferredBackend = getSelectedStorageBackend() so save follows highlight'
      - When current backend is local or file, show "Move to File" or "Move to browser" toggle; click reuses move path; hidden when backend is pinboard or no bookmark
      - Pinboard storage option disabled in popup when no API token (updateStoragePinboardEnabled from getAuthToken)
  code_locations:
    files:
      - path: src/ui/popup/popup.html
        description: Storage select markup
      - path: src/ui/popup/UIManager.js
        description: updateStoragePinboardEnabled(hasApiKey)
      - path: src/ui/popup/PopupController.js
        description: Load backend, handle move, getSelectedStorageBackend, preferredBackend on save
    functions: []
  traceability:
    architecture:
      - ARCH-MOVE_BOOKMARK_UI
    requirements:
      - REQ-MOVE_BOOKMARK_STORAGE_UI
      - REQ-STORAGE_MODE_DEFAULT
    tests: []
    code_annotations:
      - IMPL-MOVE_BOOKMARK_UI
  related_decisions:
    depends_on:
      - ARCH-MOVE_BOOKMARK_UI
    supersedes: []
    see_also:
      - IMPL-BOOKMARK_ROUTER
    composed_with:
      - IMPL-BOOKMARK_ROUTER
      - IMPL-STORAGE_INDEX
      - IMPL-MOVE_BOOKMARK_RESPONSE_AND_URL
  essence_pseudocode: |
    INPUT: currentUrl (tab), currentPin (current bookmark if any), user action (select storage button, save, toggle file/browser)
    OUTPUT: highlighted storage button; move request; save request with preferredBackend
    DATA: storage section with four buttons (Pinboard, Local, File, Sync); one has aria-pressed="true"

    ON popup load (or bookmark data load):
      IF currentPin exists: backend = send getStorageBackendForUrl(currentUrl)
      ELSE: backend = defaultStorageMode
      SET highlighted button to backend (data-backend attribute)
      IF backend is local or file: SHOW "Move to File" / "Move to browser" toggle
      ELSE: HIDE toggle
      updateStoragePinboardEnabled(hasApiToken)

    ON storage button click (user selects different backend):
      url = currentPin?.url || currentTab?.url
      SEND moveBookmarkToStorage(url, targetBackend)
      result = response?.data ?? response   // inner result (IMPL-MOVE_BOOKMARK_RESPONSE_AND_URL)
      IF result.success: refresh bookmark data; update highlighted button and toggle
      ELSE: show error from result

    ON save (createBookmark, addTagsToBookmark, toggle private, toggle read-later):
      data.preferredBackend = getSelectedStorageBackend()   // button with aria-pressed="true"
      SEND saveBookmark(data)   // router uses preferredBackend
  detail_file: implementation-decisions/IMPL-MOVE_BOOKMARK_UI.yaml
  metadata:
    created:
      date: '2026-02-18'
      author: MCP converter
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical YAML rewrite; add essence_pseudocode and composed_with; remove extraneous keys
    last_validated:
      date: '2026-02-18'
      validator: MCP converter
      result: pass
