IMPL-AI_TAGGING_READABILITY:
  name: Page Content via Readability
  status: Active
  cross_references:
    - ARCH-AI_TAGGING_FLOW
    - REQ-AI_TAGGING_POPUP
  rationale:
    why: AI needs main article/content text, not full HTML; Readability extracts readable content
    problems_solved: []
    benefits:
      - Smaller payload for API; better tag relevance
  implementation_approach:
    summary: Page content for AI is obtained by the service worker via scripting.executeScript with an inline function (title + body.innerText, 16k cap), so the flow works when the content script was not injected (e.g. tab opened before extension load). When the content script is present, an early top-level GET_PAGE_CONTENT listener runs Readability (extractPageContent) for richer extraction.
    details:
      - SW handleGetPageContent: uses scripting.executeScript({ target: { tabId }, func }) where func returns { title: document.title, textContent: document.body?.innerText } trimmed and capped at 16000 chars. No dependency on content script.
      - Content script: early browser.runtime.onMessage listener (registered before init() / waitForDOM()) handles GET_PAGE_CONTENT by calling extractPageContent(document) and sendResponse. When present, this provides Readability-based extraction; the class handleMessage no longer handles GET_PAGE_CONTENT to avoid double response.
      - extractPageContent in readability-extract.js: @mozilla/readability on document clone; cap 16k; fallback to document.title and body.innerText if parse returns null
  code_locations:
    files:
      - path: src/core/message-handler.js
        description: handleGetPageContent uses scripting.executeScript with inline extractInPage function
      - path: src/features/content/content-main.js
        description: Early GET_PAGE_CONTENT listener (top-level) calling extractPageContent(document)
      - path: src/features/ai/readability-extract.js
        description: extractPageContent(document) used by content script early listener
    functions:
      - name: handleGetPageContent
        file: src/core/message-handler.js
        description: SW: executeScript with inline func returning { title, textContent }; 16k cap
      - name: extractPageContent
        file: src/features/ai/readability-extract.js
        description: Returns { title, textContent } from document clone (Readability or fallback)
  traceability:
    architecture:
      - ARCH-AI_TAGGING_FLOW
    requirements:
      - REQ-AI_TAGGING_POPUP
    tests:
      - tests/unit/readability-extract.test.js (with jsdom or fixture HTML)
    code_annotations:
      - IMPL-AI_TAGGING_READABILITY
  related_decisions:
    depends_on: []
    supersedes: []
    see_also:
      - IMPL-AI_TAGGING_PROVIDER
    composed_with: []
  essence_pseudocode: |
    # [IMPL-AI_TAGGING_READABILITY] [ARCH-AI_TAGGING_FLOW] [REQ-AI_TAGGING_POPUP]
    # Extract main content from document: Readability when available, else title + body.innerText; cap at maxLength.

    # Contract: input = document (or run in page context); output = { title, textContent }; maxLength cap (e.g. 16k).
    INPUT: document (or run in page context)
    OUTPUT: { title: string, textContent: string }
    DATA: maxLength (e.g. 16000)

    # Clone document; Readability.parse; use result title/text or fallback to document.title and body.innerText; cap text length.
    extractPageContent(document):
      clone = document.cloneNode(true)
      result = Readability.parse(clone)  // @mozilla/readability
      IF result:
        title = result.title ?? document.title
        text = result.textContent ?? ''
      ELSE:
        title = document.title
        text = document.body ? document.body.innerText : ''
      IF text.length > maxLength THEN text = text.slice(0, maxLength)
      RETURN { title, textContent: text }
  detail_file: implementation-decisions/IMPL-AI_TAGGING_READABILITY.yaml
  metadata:
    created:
      date: '2026-02-20'
      author: AI Agent
    last_updated:
      date: '2026-02-21'
      author: AI Agent
      reason: GET_PAGE_CONTENT implemented in SW via executeScript (no content script dependency); content script early listener for Readability when present
