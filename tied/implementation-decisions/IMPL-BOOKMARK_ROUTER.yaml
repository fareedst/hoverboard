IMPL-BOOKMARK_ROUTER:
  name: Bookmark Router
  status: Active
  cross_references:
    - REQ-PER_BOOKMARK_STORAGE_BACKEND
    - REQ-STORAGE_MODE_DEFAULT
    - REQ-MOVE_BOOKMARK_STORAGE_UI
    - ARCH-STORAGE_INDEX_AND_ROUTER
    - IMPL-STORAGE_INDEX
    - IMPL-MOVE_BOOKMARK_UI
  rationale:
    why: Delegate bookmark operations to correct provider per URL using storage index; aggregate getRecentBookmarks; save follows popup UI selection when preferredBackend is sent.
    problems_solved:
      - Single provider cannot support per-bookmark backends
      - Save not following highlighted storage when creating bookmark from popup
    benefits:
      - getBookmarkForUrl, saveBookmark, deleteBookmark, saveTag, deleteTag delegate by URL
      - saveBookmark honors data.preferredBackend (popup UI selection) so save follows the highlight (REQ-STORAGE_MODE_DEFAULT, REQ-MOVE_BOOKMARK_STORAGE_UI)
      - getRecentBookmarks aggregates pinboard + local + file + sync, sorted by time
      - getStorageBackendForUrl(url), moveBookmarkToStorage(url, targetBackend) for move UI
  implementation_approach:
    summary: BookmarkRouter in src/features/storage/bookmark-router.js; holds pinboardProvider, localProvider, fileProvider, syncProvider, storageIndex, defaultStorageMode.
    details:
      - 'Resolve provider: (valid data.preferredBackend) || getBackendForUrl(url) || defaultStorageMode; map to one of four providers (pinboard, local, file, sync)'
      - 'moveBookmarkToStorage: get bookmark from current backend, save to target, delete from source, update index'
  code_locations:
    files:
      - path: src/features/storage/bookmark-router.js
        description: BookmarkRouter implementation
    functions: []
  traceability:
    architecture:
      - ARCH-STORAGE_INDEX_AND_ROUTER
    requirements:
      - REQ-PER_BOOKMARK_STORAGE_BACKEND
      - REQ-STORAGE_MODE_DEFAULT
      - REQ-MOVE_BOOKMARK_STORAGE_UI
    tests:
      - tests/unit/bookmark-router.test.js
    code_annotations:
      - IMPL-BOOKMARK_ROUTER
  related_decisions:
    depends_on:
      - IMPL-STORAGE_INDEX
      - ARCH-STORAGE_INDEX_AND_ROUTER
    supersedes: []
    see_also:
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-FILE_BOOKMARK_SERVICE
    composed_with:
      - IMPL-STORAGE_INDEX
      - IMPL-LOCAL_BOOKMARK_SERVICE
      - IMPL-FILE_BOOKMARK_SERVICE
      - IMPL-MOVE_BOOKMARK_UI
  essence_pseudocode: |
    INPUT: url, data (for save/tag), count (for getRecentBookmarks); optional data.preferredBackend
    OUTPUT: bookmark or list of bookmarks or success/error; providers = { pinboard, local, file, sync }
    DATA: storageIndex, defaultStorageMode, providerMap (backend name -> provider instance)

    resolveProvider(url, data):
      IF data.preferredBackend is valid (pinboard|local|file|sync): RETURN providerMap[data.preferredBackend]
      backend = storageIndex.getBackendForUrl(url)
      IF backend: RETURN providerMap[backend]
      RETURN providerMap[defaultStorageMode]

    getBookmarkForUrl(url):
      provider = resolveProvider(url, {})
      RETURN provider.getBookmarkForUrl(url)

    saveBookmark(data):
      url = data.url
      provider = resolveProvider(url, data)
      result = provider.saveBookmark(data)
      IF result.success: storageIndex.setBackendForUrl(url, providerBackend)
      RETURN result

    deleteBookmark(url), saveTag(data), deleteTag(data):
      provider = resolveProvider(url, data)
      RETURN provider.<operation>(...)

    getRecentBookmarks(count):
      merged = []
      FOR each provider IN [pinboard, local, file, sync]:
        merged = merged CONCAT provider.getRecentBookmarks(count)
      SORT merged BY time DESCENDING
      RETURN merged[0..count-1]

    moveBookmarkToStorage(url, targetBackend):
      sourceBackend = storageIndex.getBackendForUrl(url)
      sourceProvider = providerMap[sourceBackend]
      targetProvider = providerMap[targetBackend]
      bookmark = sourceProvider.getBookmarkForUrl(url)
      IF bookmark lacks time: SET bookmark.time = now
      targetProvider.saveBookmark(bookmark)
      sourceProvider.deleteBookmark(url)
      storageIndex.setBackendForUrl(url, targetBackend)
  detail_file: implementation-decisions/IMPL-BOOKMARK_ROUTER.yaml
  metadata:
    created:
      date: '2026-02-18'
      author: MCP converter
    last_updated:
      date: '2026-02-18'
      author: AI Agent
      reason: saveBookmark honors data.preferredBackend (save follows highlight)
    last_validated:
      date: '2026-02-18'
      validator: MCP converter
      result: pass
