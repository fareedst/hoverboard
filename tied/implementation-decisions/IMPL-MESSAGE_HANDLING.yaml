IMPL-MESSAGE_HANDLING:
  name: Message Handling System Implementation
  status: Active
  cross_references:
    - ARCH-MESSAGE_HANDLING
    - REQ-SMART_BOOKMARKING
  rationale:
    why: Concrete message routing and handling
    problems_solved:
      - Complex routing logic
      - Message validation
    benefits:
      - Centralized communication
      - Type-safe messages
  implementation_approach:
    summary: Message service with type validation, routing, error handling
    details:
      - Standardized message types
      - Async request/response
      - Error handling
      - Input validation
      - Messaging protocol tests validate SW routing, MessageHandler contracts, content/offscreen/popup contracts, MessageClient retry, and type drift (see traceability.tests and docs/architecture/extension-messaging-protocols.md)
  code_locations:
    files:
      - path: src/core/message-service.js
        description: Message service
      - path: src/core/message-handler.js
        description: Message handler
    functions: []
  traceability:
    architecture:
      - ARCH-MESSAGE_HANDLING
    requirements:
      - REQ-SMART_BOOKMARKING
      - REQ-BOOKMARK_STATE_SYNCHRONIZATION
    tests:
      - tests/unit/module-import-fix.test.js
      - tests/unit/message-handler-runtime-validation.test.js
      - tests/unit/message-handler-local-save-recall.test.js
      - tests/unit/message-schemas.test.js
      - tests/unit/message-handler-contracts.test.js
      - tests/unit/service-worker-messaging-routing.test.js
      - tests/unit/content-messaging-contracts.test.js
      - tests/unit/popup-message-contract.test.js
      - tests/unit/offscreen-file-bookmark-messaging.test.js
      - tests/unit/message-client.test.js
      - tests/unit/message-type-drift.test.js
      - tests/playwright/extension-messaging.spec.js
    code_annotations:
      - IMPL-MESSAGE_HANDLING
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
    composed_with:
      - IMPL-POPUP_MESSAGE_TIMEOUT
      - IMPL-BOOKMARK_STATE_SYNC
  essence_pseudocode: |
    # [IMPL-MESSAGE_HANDLING] [ARCH-MESSAGE_HANDLING] [REQ-SMART_BOOKMARKING] [REQ-BOOKMARK_STATE_SYNCHRONIZATION]
    # Message routing with type validation and handler map; send and processMessage.
    # Contract: message shape, Promise result, allowlist and handler map.
    INPUT: message { type, payload }; sender (tab/popup/background)
    OUTPUT: Promise resolving to handler result or rejecting on validation/error
    DATA: message types (allowlist); handler map type -> handler fn

    # Validate type and payload, route to handler, return Promise.
    send(message):
      VALIDATE message.type in allowlist
      VALIDATE payload shape
      ROUTE to handler for message.type
      handler(message) -> result; RETURN Promise.resolve(result)
      ON error: RETURN Promise.reject; optional log

    # Lookup handler by type, await result; caller may broadcast BOOKMARK_UPDATED.
    processMessage(message) (in message-handler):
      handler = lookup(message.type); result = AWAIT handler(message.payload)
      RETURN result; (caller may broadcast BOOKMARK_UPDATED etc.)
  detail_file: implementation-decisions/IMPL-MESSAGE_HANDLING.yaml
  metadata:
    created:
      date: "2025-07-14"
      author: AI Agent
    last_updated:
      date: "2026-02-26"
      author: AI Agent
      reason: Align essence_pseudocode with standard (one-action-per-step)
