IMPL-RECENT_TAGS_POPUP_REFRESH:
  name: Recent Tags refresh on every popup display
  status: Active
  cross_references:
    - REQ-RECENT_TAGS_SYSTEM
    - ARCH-POPUP_SESSION
  rationale:
    why: In reused popup documents the Recent Tags list might not refresh when popup is shown again; users expect list to reflect shared service-worker state every time. Fix: refresh on visibility change when popup becomes visible and initialized.
    problems_solved:
      - Stale Recent Tags list when popup is reopened without full reload
    benefits: []
  implementation_approach:
    summary: setupAutoRefresh() adds document visibilitychange listener; when document.visibilityState === 'visible' and controller initialized and !isLoading, call loadRecentTags() so UI reflects recentTagsMemory every time popup is displayed.
    details: []
  code_locations:
    files:
      - path: src/ui/popup/PopupController.js
        description: setupAutoRefresh, loadRecentTags on visibilitychange
    functions:
      - name: setupAutoRefresh
        file: src/ui/popup/PopupController.js
        description: Adds visibilitychange listener that invokes loadRecentTags() when visible and initialized
  traceability:
    architecture:
      - ARCH-POPUP_SESSION
    requirements:
      - REQ-RECENT_TAGS_SYSTEM
    tests:
      - tests/unit/tag-recent-behavior.test.js
      - tests/unit/tag-recent-tracking.test.js
    code_annotations:
      - IMPL-RECENT_TAGS_POPUP_REFRESH
  related_decisions:
    depends_on: []
    supersedes: []
    see_also: []
    composed_with: []
  essence_pseudocode: |
    INPUT: none (event-driven)
    OUTPUT: void (side effect â€” UI updated with latest recent tags)
    DATA: document.visibilityState; controller initialized flag; isLoading guard; loadRecentTags() (fetches from service worker recentTagsMemory)

    setupAutoRefresh():
      REGISTER document.addEventListener("visibilitychange", handler)

    handler():
      IF document.visibilityState !== "visible" THEN RETURN
      IF NOT controller.initialized OR controller.isLoading THEN RETURN
      loadRecentTags()
      (UI updates from returned data)

    effect: Every time popup document becomes visible (e.g. user reopens popup), Recent Tags list is refreshed so tags saved in one window appear when popup is shown in this or another window.
  detail_file: implementation-decisions/IMPL-RECENT_TAGS_POPUP_REFRESH.yaml
  metadata:
    created:
      date: '2026-02-18'
      author: MCP converter
    last_updated:
      date: '2026-02-20'
      author: AI Agent
      reason: Canonical YAML rewrite; add essence_pseudocode and composed_with; remove extraneous keys
    last_validated:
      date: '2026-02-18'
      validator: MCP converter
      result: pass
